# ì‚¬ì£¼/íƒ€ë¡œ/ì—°ì•  ì´ë¯¸ì§€ ìë™ ìƒì„±ê¸°
import streamlit as st
import pandas as pd
from datetime import datetime
import zipfile
import io
import os
from korean_lunar_calendar import KoreanLunarCalendar

from saju_calculator import (
    calc_ì‚¬ì£¼, calc_ëŒ€ìš´, calc_ì„¸ìš´, calc_ì›”ìš´, calc_ì‹ ì‚´,
    calc_í•©ì¶©í˜•íŒŒí•´, calc_ì²œê°„í•©, calc_ê¶ì„±, calc_ìœ¡ì¹œ, 
    calc_ë‚©ìŒì˜¤í–‰, calc_ê²©êµ­, calc_ê³µë§_ì „ì²´, calc_ìš©ì‹ 
)
from image_generator import (
    create_ì›êµ­í‘œ, create_ëŒ€ìš´í‘œ, create_ì„¸ìš´í‘œ, create_ì›”ìš´í‘œ, 
    create_ì˜¤í–‰ì°¨íŠ¸, create_ì‹­ì„±í‘œ, create_ì‹ ì‚´í‘œ,
    create_12ìš´ì„±í‘œ, create_ì§€ì¥ê°„í‘œ, create_í•©ì¶©í˜•íŒŒí•´í‘œ,
    create_ê¶ì„±í‘œ, create_ìœ¡ì¹œí‘œ, create_ë‚©ìŒì˜¤í–‰í‘œ,
    create_ê²©êµ­í‘œ, create_ê³µë§í‘œ, create_ìš©ì‹ í‘œ, create_ì¼ì§„í‘œ
)

# 12ì§€ ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •
ZODIAC_PATH = os.path.join(os.path.dirname(__file__), 'images', 'zodiac')

# ============================================
# GPTìš© í…ìŠ¤íŠ¸ í¬ë§· ìƒì„± í•¨ìˆ˜
# ============================================
def generate_gpt_text(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, gender, ëŒ€ìš´_data, ì„¸ìš´_data, ì›”ìš´_data, ì‹ ì‚´_data):
    """GPT í•´ì„ìš© í‘œì¤€ í…ìŠ¤íŠ¸ í¬ë§· ìƒì„±"""
    
    # ì¶”ê°€ ê³„ì‚°
    ìš©ì‹ _data = calc_ìš©ì‹ (ì‚¬ì£¼)
    í•©ì¶©í˜•íŒŒí•´ = calc_í•©ì¶©í˜•íŒŒí•´(ì‚¬ì£¼)
    ì²œê°„í•© = calc_ì²œê°„í•©(ì‚¬ì£¼)
    ê¶ì„± = calc_ê¶ì„±(ì‚¬ì£¼)
    ìœ¡ì¹œ = calc_ìœ¡ì¹œ(ì‚¬ì£¼, gender)
    ë‚©ìŒ = calc_ë‚©ìŒì˜¤í–‰(ì‚¬ì£¼)
    ê²©êµ­ = calc_ê²©êµ­(ì‚¬ì£¼)
    ê³µë§ = calc_ê³µë§_ì „ì²´(ì‚¬ì£¼)
    
    # ì›êµ­ ë°ì´í„°
    ë…„ì£¼ = ì‚¬ì£¼['ë…„ì£¼']
    ì›”ì£¼ = ì‚¬ì£¼['ì›”ì£¼']
    ì¼ì£¼ = ì‚¬ì£¼['ì¼ì£¼']
    ì‹œì£¼ = ì‚¬ì£¼['ì‹œì£¼']
    ì²œê°„ì‹­ì„± = ì‚¬ì£¼['ì²œê°„ì‹­ì„±']
    ì§€ì§€ì‹­ì„± = ì‚¬ì£¼['ì§€ì§€ì‹­ì„±']
    ìš´ì„± = ì‚¬ì£¼['12ìš´ì„±']
    ì§€ì¥ê°„ = ì‚¬ì£¼['ì§€ì¥ê°„']
    ì˜¤í–‰ = ì‚¬ì£¼['ì˜¤í–‰']
    
    text = f"""â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ ì‚¬ì£¼ ë¶„ì„ ê¸°ì¤€ ë°ì´í„° (GPT í•´ì„ìš©)
â€» ë³¸ ë°ì´í„°ëŠ” ê³„ì‚° ê²°ê³¼ì´ë©°, í•´ì„Â·í‰ê°€Â·ì˜ë¯¸ ë¶€ì—¬ëŠ”
   ì¥ë³„ ë¶„ì„ í”„ë¡¬í”„íŠ¸ì—ì„œë§Œ ìˆ˜í–‰í•  ê²ƒ.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â–  ê¸°ë³¸ì •ë³´
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì´ë¦„: {ê¸°ë³¸ì •ë³´['ì´ë¦„']}
ì„±ë³„: {ê¸°ë³¸ì •ë³´['ì„±ë³„']}
ë‚˜ì´: {ê¸°ë³¸ì •ë³´['ë‚˜ì´']}ì„¸
ì–‘ë ¥: {ê¸°ë³¸ì •ë³´['ì–‘ë ¥']}
ìŒë ¥: {ê¸°ë³¸ì •ë³´['ìŒë ¥']}

â–  1. ì›êµ­í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        ì‹œì£¼        ì¼ì£¼        ì›”ì£¼        ë…„ì£¼
ì²œê°„    {ì‹œì£¼[0]}          {ì¼ì£¼[0]}          {ì›”ì£¼[0]}          {ë…„ì£¼[0]}
ì§€ì§€    {ì‹œì£¼[1]}          {ì¼ì£¼[1]}          {ì›”ì£¼[1]}          {ë…„ì£¼[1]}
ì²œê°„ì‹­ì„± {ì²œê°„ì‹­ì„±['ì‹œ']}     (ì¼ê°„)      {ì²œê°„ì‹­ì„±['ì›”']}     {ì²œê°„ì‹­ì„±['ë…„']}
ì§€ì§€ì‹­ì„± {ì§€ì§€ì‹­ì„±['ì‹œ']}     {ì§€ì§€ì‹­ì„±['ì¼']}     {ì§€ì§€ì‹­ì„±['ì›”']}     {ì§€ì§€ì‹­ì„±['ë…„']}
12ìš´ì„±  {ìš´ì„±['ì‹œ']}        {ìš´ì„±['ì¼']}        {ìš´ì„±['ì›”']}        {ìš´ì„±['ë…„']}

ì¼ê°„: {ì¼ì£¼[0]} (ì˜¤í–‰: {ìš©ì‹ _data['ì¼ê°„_ì˜¤í–‰']})

â–  2. ëŒ€ìš´í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ëŒ€ìš´ìˆ˜: {ëŒ€ìš´_data['ëŒ€ìš´ìˆ˜']}ì„¸ ì‹œì‘ | ë°©í–¥: {'ìˆœí–‰' if ëŒ€ìš´_data['ìˆœí–‰'] else 'ì—­í–‰'}
"""
    
    # ëŒ€ìš´ ëª©ë¡
    for i, ëŒ€ìš´ in enumerate(ëŒ€ìš´_data['ëŒ€ìš´'][:12]):
        text += f"{ëŒ€ìš´['ë‚˜ì´']}ì„¸: {ëŒ€ìš´['ì²œê°„']}{ëŒ€ìš´['ì§€ì§€']} | "
        if (i + 1) % 4 == 0:
            text += "\n"
    
    text += f"""
â–  3. ì„¸ìš´í‘œ (10ë…„)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
    for ì„¸ìš´ in ì„¸ìš´_data['ì„¸ìš´']:
        text += f"{ì„¸ìš´['ë…„ë„']}ë…„: {ì„¸ìš´['ì²œê°„']}{ì„¸ìš´['ì§€ì§€']} (ì²œê°„ì‹­ì„±:{ì„¸ìš´['ì²œê°„_ì‹­ì„±']}, ì§€ì§€ì‹­ì„±:{ì„¸ìš´['ì§€ì§€_ì‹­ì„±']})\n"
    
    text += f"""
â–  4. ì›”ìš´í‘œ (12ê°œì›”)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
    for ì›”ìš´ in ì›”ìš´_data['ì›”ìš´']:
        text += f"{ì›”ìš´['ë…„ë„']}ë…„ {ì›”ìš´['ì›”']}ì›”: {ì›”ìš´['ì²œê°„']}{ì›”ìš´['ì§€ì§€']} (ì²œê°„ì‹­ì„±:{ì›”ìš´['ì²œê°„_ì‹­ì„±']}, ì§€ì§€ì‹­ì„±:{ì›”ìš´['ì§€ì§€_ì‹­ì„±']})\n"
    
    text += f"""
â–  5. ì˜¤í–‰ë¶„ì„
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ëª©:{ì˜¤í–‰['ëª©']} í™”:{ì˜¤í–‰['í™”']} í† :{ì˜¤í–‰['í† ']} ê¸ˆ:{ì˜¤í–‰['ê¸ˆ']} ìˆ˜:{ì˜¤í–‰['ìˆ˜']}
ì´í•©: {sum(ì˜¤í–‰.values())}ê°œ
"""
    
    # ê°•/ì•½/ë¬´ ê³„ì‚°
    sorted_ì˜¤í–‰ = sorted(ì˜¤í–‰.items(), key=lambda x: x[1], reverse=True)
    ê°•í•œ = sorted_ì˜¤í–‰[0][0] if sorted_ì˜¤í–‰[0][1] > 0 else "-"
    ì¡´ì¬í•˜ëŠ” = [(k, v) for k, v in sorted_ì˜¤í–‰ if v > 0]
    ì•½í•œ = ì¡´ì¬í•˜ëŠ”[-1][0] if ì¡´ì¬í•˜ëŠ” else "-"
    ì—†ëŠ” = [k for k, v in ì˜¤í–‰.items() if v == 0]
    
    text += f"ê°•: {ê°•í•œ} | ì•½: {ì•½í•œ}"
    if ì—†ëŠ”:
        text += f" | ë¬´: {','.join(ì—†ëŠ”)}"
    
    text += f"""

â–  6. ì‹­ì„±í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì²œê°„ì‹­ì„±: ë…„({ì²œê°„ì‹­ì„±['ë…„']}) ì›”({ì²œê°„ì‹­ì„±['ì›”']}) ì¼(ì¼ê°„) ì‹œ({ì²œê°„ì‹­ì„±['ì‹œ']})
ì§€ì§€ì‹­ì„±: ë…„({ì§€ì§€ì‹­ì„±['ë…„']}) ì›”({ì§€ì§€ì‹­ì„±['ì›”']}) ì¼({ì§€ì§€ì‹­ì„±['ì¼']}) ì‹œ({ì§€ì§€ì‹­ì„±['ì‹œ']})

â–  7. ì‹ ì‚´í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ê¸¸ì‹ ]
"""
    if ì‹ ì‚´_data.get('ê¸¸ì‹ '):
        for ì‹ ì‚´ëª…, ìœ„ì¹˜ in ì‹ ì‚´_data['ê¸¸ì‹ ']:
            text += f"- {ì‹ ì‚´ëª…} ({ìœ„ì¹˜})\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[í‰ì‹ ]\n"
    if ì‹ ì‚´_data.get('í‰ì‹ '):
        for ì‹ ì‚´ëª…, ìœ„ì¹˜ in ì‹ ì‚´_data['í‰ì‹ ']:
            text += f"- {ì‹ ì‚´ëª…} ({ìœ„ì¹˜})\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[íŠ¹ìˆ˜ì‹ ì‚´]\n"
    if ì‹ ì‚´_data.get('íŠ¹ìˆ˜ì‹ ì‚´'):
        for ì‹ ì‚´ëª…, ìœ„ì¹˜ in ì‹ ì‚´_data['íŠ¹ìˆ˜ì‹ ì‚´']:
            text += f"- {ì‹ ì‚´ëª…} ({ìœ„ì¹˜})\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += f"""
â–  8. 12ìš´ì„±í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì¼ê°„({ì¼ì£¼[0]}) ê¸°ì¤€ ê° ì§€ì§€ë³„ 12ìš´ì„±:
ë…„ì§€({ë…„ì£¼[1]}): {ìš´ì„±['ë…„']} | ì›”ì§€({ì›”ì£¼[1]}): {ìš´ì„±['ì›”']} | ì¼ì§€({ì¼ì£¼[1]}): {ìš´ì„±['ì¼']} | ì‹œì§€({ì‹œì£¼[1]}): {ìš´ì„±['ì‹œ']}

â–  9. ì§€ì¥ê°„í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ë…„ì§€({ë…„ì£¼[1]}): {ì§€ì¥ê°„['ë…„']}
ì›”ì§€({ì›”ì£¼[1]}): {ì§€ì¥ê°„['ì›”']}
ì¼ì§€({ì¼ì£¼[1]}): {ì§€ì¥ê°„['ì¼']}
ì‹œì§€({ì‹œì£¼[1]}): {ì§€ì¥ê°„['ì‹œ']}

â–  10. í•©ì¶©í˜•íŒŒí•´í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ì²œê°„í•©]
"""
    if ì²œê°„í•©:
        for í•© in ì²œê°„í•©:
            text += f"- {í•©['ì²œê°„']} â†’ {í•©['í•©í™”']} ({í•©['ìœ„ì¹˜']})\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[ì§€ì§€ ìœ¡í•©]\n"
    if í•©ì¶©í˜•íŒŒí•´['ìœ¡í•©']:
        for í•­ëª© in í•©ì¶©í˜•íŒŒí•´['ìœ¡í•©']:
            if isinstance(í•­ëª©, dict):
                text += f"- {í•­ëª©.get('ì§€ì§€', í•­ëª©)}\n"
            else:
                text += f"- {í•­ëª©}\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[ì§€ì§€ ì‚¼í•©]\n"
    if í•©ì¶©í˜•íŒŒí•´['ì‚¼í•©']:
        for í•­ëª© in í•©ì¶©í˜•íŒŒí•´['ì‚¼í•©']:
            if isinstance(í•­ëª©, dict):
                text += f"- {í•­ëª©.get('ì§€ì§€', '')} â†’ {í•­ëª©.get('ì˜¤í–‰', '')}{'(ì™„ì„±)' if í•­ëª©.get('ì™„ì„±') else '(ë¯¸ì™„ì„±)'}\n"
            else:
                text += f"- {í•­ëª©}\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[ì§€ì§€ ë°©í•©]\n"
    if í•©ì¶©í˜•íŒŒí•´['ë°©í•©']:
        for í•­ëª© in í•©ì¶©í˜•íŒŒí•´['ë°©í•©']:
            if isinstance(í•­ëª©, dict):
                ì§€ì§€_str = ','.join(í•­ëª©.get('ì§€ì§€', []))
                text += f"- {ì§€ì§€_str} â†’ {í•­ëª©.get('ì˜¤í–‰', '')}{'(ì™„ì„±)' if í•­ëª©.get('ì™„ì„±') else '(ë¯¸ì™„ì„±)'}\n"
            else:
                text += f"- {í•­ëª©}\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[ì¶©]\n"
    if í•©ì¶©í˜•íŒŒí•´['ì¶©']:
        for í•­ëª© in í•©ì¶©í˜•íŒŒí•´['ì¶©']:
            if isinstance(í•­ëª©, dict):
                text += f"- {í•­ëª©.get('ìœ„ì¹˜', '')}: {í•­ëª©.get('ì§€ì§€', '')}\n"
            else:
                text += f"- {í•­ëª©}\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[í˜•]\n"
    if í•©ì¶©í˜•íŒŒí•´['í˜•']:
        for í•­ëª© in í•©ì¶©í˜•íŒŒí•´['í˜•']:
            if isinstance(í•­ëª©, dict):
                text += f"- {í•­ëª©.get('ìœ„ì¹˜', '')}: {í•­ëª©.get('ì§€ì§€', '')}\n"
            else:
                text += f"- {í•­ëª©}\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[íŒŒ]\n"
    if í•©ì¶©í˜•íŒŒí•´['íŒŒ']:
        for í•­ëª© in í•©ì¶©í˜•íŒŒí•´['íŒŒ']:
            if isinstance(í•­ëª©, dict):
                text += f"- {í•­ëª©.get('ìœ„ì¹˜', '')}: {í•­ëª©.get('ì§€ì§€', '')}\n"
            else:
                text += f"- {í•­ëª©}\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += "\n[í•´]\n"
    if í•©ì¶©í˜•íŒŒí•´['í•´']:
        for í•­ëª© in í•©ì¶©í˜•íŒŒí•´['í•´']:
            if isinstance(í•­ëª©, dict):
                text += f"- {í•­ëª©.get('ìœ„ì¹˜', '')}: {í•­ëª©.get('ì§€ì§€', '')}\n"
            else:
                text += f"- {í•­ëª©}\n"
    else:
        text += "- ì—†ìŒ\n"
    
    text += f"""
â–  11. ê¶ì„±í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ë…„ì£¼: {ê¶ì„±['ë…„ì£¼']['ê¶']} - {ê¶ì„±['ë…„ì£¼']['ì˜ë¯¸']}
ì›”ì£¼: {ê¶ì„±['ì›”ì£¼']['ê¶']} - {ê¶ì„±['ì›”ì£¼']['ì˜ë¯¸']}
ì¼ì£¼: {ê¶ì„±['ì¼ì£¼']['ê¶']} - {ê¶ì„±['ì¼ì£¼']['ì˜ë¯¸']}
ì‹œì£¼: {ê¶ì„±['ì‹œì£¼']['ê¶']} - {ê¶ì„±['ì‹œì£¼']['ì˜ë¯¸']}

â–  12. ìœ¡ì¹œí‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""
    for ì£¼, ë°ì´í„° in ìœ¡ì¹œ.items():
        ì²œê°„_ìœ¡ì¹œ = ë°ì´í„°['ì²œê°„']['ìœ¡ì¹œ']
        ì§€ì§€_ìœ¡ì¹œ = ë°ì´í„°['ì§€ì§€']['ìœ¡ì¹œ']
        text += f"{ì£¼}ì£¼: ì²œê°„({ì²œê°„_ìœ¡ì¹œ}), ì§€ì§€({ì§€ì§€_ìœ¡ì¹œ})\n"
    
    text += f"""
â–  13. ë‚©ìŒì˜¤í–‰í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ë…„ì£¼({ë…„ì£¼[0]}{ë…„ì£¼[1]}): {ë‚©ìŒ['ë…„']['ë‚©ìŒ']} - {ë‚©ìŒ['ë…„']['ì„¤ëª…']}
ì›”ì£¼({ì›”ì£¼[0]}{ì›”ì£¼[1]}): {ë‚©ìŒ['ì›”']['ë‚©ìŒ']} - {ë‚©ìŒ['ì›”']['ì„¤ëª…']}
ì¼ì£¼({ì¼ì£¼[0]}{ì¼ì£¼[1]}): {ë‚©ìŒ['ì¼']['ë‚©ìŒ']} - {ë‚©ìŒ['ì¼']['ì„¤ëª…']}
ì‹œì£¼({ì‹œì£¼[0]}{ì‹œì£¼[1]}): {ë‚©ìŒ['ì‹œ']['ë‚©ìŒ']} - {ë‚©ìŒ['ì‹œ']['ì„¤ëª…']}

â–  14. ê²©êµ­í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ì •ê²©: {ê²©êµ­['ì •ê²©']}
íŠ¹ìˆ˜ê²©: {', '.join(ê²©êµ­['íŠ¹ìˆ˜ê²©']) if ê²©êµ­['íŠ¹ìˆ˜ê²©'] else 'ì—†ìŒ'}
ì›”ì§€: {ê²©êµ­['ì›”ì§€']} (ë³¸ê¸°: {ê²©êµ­['ì›”ì§€_ë³¸ê¸°']})

â–  15. ê³µë§í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ë…„ì£¼ ê¸°ì¤€ ê³µë§: {ê³µë§['ë…„']['ê³µë§'][0]}, {ê³µë§['ë…„']['ê³µë§'][1]} ({ê³µë§['ë…„']['ìˆœ']})
ì¼ì£¼ ê¸°ì¤€ ê³µë§: {ê³µë§['ì¼']['ê³µë§'][0]}, {ê³µë§['ì¼']['ê³µë§'][1]} ({ê³µë§['ì¼']['ìˆœ']})
ì›êµ­ ë‚´ ê³µë§ í•´ë‹¹: {', '.join(ê³µë§['ê³µë§_í•´ë‹¹']) if ê³µë§['ê³µë§_í•´ë‹¹'] else 'ì—†ìŒ'}

â–  16. ìš©ì‹ í‘œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
[ì‹ ê°•/ì‹ ì•½] {ìš©ì‹ _data['ì‹ ê°•ì•½']} ({ìš©ì‹ _data['ì‹ ê°•ì ìˆ˜']})

[ì¡°í›„ìš©ì‹ ] {ìš©ì‹ _data['ì¡°í›„_ìš©ì‹ ']}
[ì–µë¶€ìš©ì‹ ] {ìš©ì‹ _data['ì–µë¶€_ìš©ì‹ ']}
[í†µê´€ìš©ì‹ ] {ìš©ì‹ _data['í†µê´€_ìš©ì‹ '] if ìš©ì‹ _data['í†µê´€_ìš©ì‹ '] else 'ì—†ìŒ'}

[5ì‹ ]
ìš©ì‹ : {ìš©ì‹ _data['ìš©ì‹ ']}
í¬ì‹ : {ìš©ì‹ _data['í¬ì‹ ']}
í•œì‹ : {ìš©ì‹ _data['í•œì‹ ']}
ê¸°ì‹ : {ìš©ì‹ _data['ê¸°ì‹ ']}
êµ¬ì‹ : {ìš©ì‹ _data['êµ¬ì‹ ']}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â–  [ì¶”ê°€ì •ë³´-ê³µí†µ]
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- ì§ì—…/ì—…ì¢…: 
- í˜„ì¬ ê°€ì¥ í° ê³ ë¯¼: 
- ìƒë‹´ ëª©ì : 
- ë¯¼ê°í•˜ê±°ë‚˜ í”¼í•˜ê³  ì‹¶ì€ ì£¼ì œ: 

â–  [ì¶”ê°€ì •ë³´-ì œnì¥] (í•„ìš”í•œ ì¥ ë²ˆí˜¸ë§Œ ì‚¬ìš©)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- ì´ ì¥ì—ì„œ ê¼­ ë‹¤ë¤„ì•¼ í•  ìƒí™©: 
- í˜„ì¬ ì‹œì /ê³„íš: 
- íŠ¹ë³„íˆ ë°˜ì˜í•  ì¡°ê±´: 

"""
    
    return text

# ============================================
# ìŒë ¥ â†’ ì–‘ë ¥ ë³€í™˜ í•¨ìˆ˜
# ============================================
def ìŒë ¥_to_ì–‘ë ¥(year, month, day, ìœ¤ë‹¬=False):
    """ìŒë ¥ ë‚ ì§œë¥¼ ì–‘ë ¥ìœ¼ë¡œ ë³€í™˜ (ìœ¤ë‹¬ ì§€ì›)"""
    calendar = KoreanLunarCalendar()
    calendar.setLunarDate(year, month, day, ìœ¤ë‹¬)
    return calendar.solarYear, calendar.solarMonth, calendar.solarDay

def ì–‘ë ¥_to_ìŒë ¥(year, month, day):
    """ì–‘ë ¥ ë‚ ì§œë¥¼ ìŒë ¥ìœ¼ë¡œ ë³€í™˜ (ìœ¤ë‹¬ ì—¬ë¶€ í¬í•¨)"""
    calendar = KoreanLunarCalendar()
    calendar.setSolarDate(year, month, day)
    ìœ¤ë‹¬ì—¬ë¶€ = calendar.isIntercalation
    return calendar.lunarYear, calendar.lunarMonth, calendar.lunarDay, ìœ¤ë‹¬ì—¬ë¶€

def ìŒë ¥_ë¬¸ìì—´(year, month, day, ìœ¤ë‹¬=False):
    """ìŒë ¥ ë‚ ì§œë¥¼ ë¬¸ìì—´ë¡œ ë³€í™˜ (ìœ¤ë‹¬ í‘œì‹œ í¬í•¨)"""
    ìœ¤_í‘œì‹œ = "ìœ¤" if ìœ¤ë‹¬ else ""
    return f"{year}-{ìœ¤_í‘œì‹œ}{month:02d}-{day:02d}"

# ============================================
# í˜ì´ì§€ ì„¤ì •
# ============================================
st.set_page_config(
    page_title="ì‚¬ì£¼ ì´ë¯¸ì§€ ìƒì„±ê¸°",
    page_icon="ğŸ”®",
    layout="wide"
)

st.title("ğŸ”® ì‚¬ì£¼/íƒ€ë¡œ/ì—°ì•  ì´ë¯¸ì§€ ìƒì„±ê¸°")

# ============================================
# ì‚¬ì´ë“œë°”
# ============================================
with st.sidebar:
    st.header("ğŸ”® ì„œë¹„ìŠ¤ ì„ íƒ")
    ì„œë¹„ìŠ¤ = st.radio(
        "ìƒì„±í•  ì´ë¯¸ì§€ ì¢…ë¥˜",
        ["ì‚¬ì£¼", "íƒ€ë¡œ (ì¤€ë¹„ì¤‘)", "ì—°ì• ìƒë‹´ (ì¤€ë¹„ì¤‘)"]
    )
    
    st.divider()
    
    st.header("ğŸ“Š ìƒì„±í•  ì´ë¯¸ì§€")
    
    # ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤
    ì „ì²´ì„ íƒ = st.checkbox("âœ… ì „ì²´ ì„ íƒ", value=True, key="select_all")
    
    st.divider()
    
    ì›êµ­í‘œ_ì²´í¬ = st.checkbox("ì›êµ­í‘œ", value=ì „ì²´ì„ íƒ)
    ëŒ€ìš´í‘œ_ì²´í¬ = st.checkbox("ëŒ€ìš´í‘œ", value=ì „ì²´ì„ íƒ)
    ì„¸ìš´í‘œ_ì²´í¬ = st.checkbox("ì„¸ìš´í‘œ", value=ì „ì²´ì„ íƒ)
    ì›”ìš´í‘œ_ì²´í¬ = st.checkbox("ì›”ìš´í‘œ", value=ì „ì²´ì„ íƒ)
    ì˜¤í–‰ì°¨íŠ¸_ì²´í¬ = st.checkbox("ì˜¤í–‰ ë¶„ì„", value=ì „ì²´ì„ íƒ)
    ì‹­ì„±í‘œ_ì²´í¬ = st.checkbox("ì‹­ì„±í‘œ", value=ì „ì²´ì„ íƒ)
    ì‹ ì‚´í‘œ_ì²´í¬ = st.checkbox("ì‹ ì‚´í‘œ", value=ì „ì²´ì„ íƒ)
    ìš´ì„±í‘œ_ì²´í¬ = st.checkbox("12ìš´ì„±í‘œ", value=ì „ì²´ì„ íƒ)
    ì§€ì¥ê°„í‘œ_ì²´í¬ = st.checkbox("ì§€ì¥ê°„í‘œ", value=ì „ì²´ì„ íƒ)
    í•©ì¶©í˜•íŒŒí•´í‘œ_ì²´í¬ = st.checkbox("í•©ì¶©í˜•íŒŒí•´í‘œ", value=ì „ì²´ì„ íƒ)
    ê¶ì„±í‘œ_ì²´í¬ = st.checkbox("ê¶ì„±í‘œ", value=ì „ì²´ì„ íƒ)
    ìœ¡ì¹œí‘œ_ì²´í¬ = st.checkbox("ìœ¡ì¹œí‘œ", value=ì „ì²´ì„ íƒ)
    ë‚©ìŒì˜¤í–‰í‘œ_ì²´í¬ = st.checkbox("ë‚©ìŒì˜¤í–‰í‘œ", value=ì „ì²´ì„ íƒ)
    ê²©êµ­í‘œ_ì²´í¬ = st.checkbox("ê²©êµ­í‘œ", value=ì „ì²´ì„ íƒ)
    ê³µë§í‘œ_ì²´í¬ = st.checkbox("ê³µë§í‘œ", value=ì „ì²´ì„ íƒ)
    ìš©ì‹ í‘œ_ì²´í¬ = st.checkbox("ìš©ì‹ í‘œ", value=ì „ì²´ì„ íƒ)
    
    st.divider()
    st.caption("v1.0 - ì‚¬ì£¼ ì´ë¯¸ì§€ ìƒì„±ê¸°")

# ============================================
# íƒ­ êµ¬ì„±
# ============================================
tab1, tab2, tab3 = st.tabs(["ğŸ“ ê°œë³„ ì…ë ¥", "ğŸ“Š ì—‘ì…€ ì¼ê´„ ì²˜ë¦¬", "ğŸ“… ì¼ì§„í‘œ"])

# ============================================
# íƒ­1: ê°œë³„ ì…ë ¥
# ============================================
with tab1:
    st.subheader("ê³ ê° ì •ë³´ ì…ë ¥")
    
    # session_state ì´ˆê¸°í™”
    if 'input_ì´ë¦„' not in st.session_state:
        st.session_state.input_ì´ë¦„ = ""
    if 'input_ìƒë…„ì›”ì¼' not in st.session_state:
        st.session_state.input_ìƒë…„ì›”ì¼ = datetime(1990, 1, 1)
    if 'input_ì‹œ' not in st.session_state:
        st.session_state.input_ì‹œ = 12
    if 'input_ë¶„' not in st.session_state:
        st.session_state.input_ë¶„ = 0
    if 'input_ì„±ë³„' not in st.session_state:
        st.session_state.input_ì„±ë³„ = "ë‚¨ì„±"
    if 'input_ìŒì–‘ë ¥' not in st.session_state:
        st.session_state.input_ìŒì–‘ë ¥ = "ì–‘ë ¥"
    if 'input_ìœ¤ë‹¬' not in st.session_state:
        st.session_state.input_ìœ¤ë‹¬ = False
    if 'ìƒì„±ëœ_ì´ë¯¸ì§€' not in st.session_state:
        st.session_state.ìƒì„±ëœ_ì´ë¯¸ì§€ = {}
    
    col1, col2 = st.columns(2)
    
    with col1:
        ì´ë¦„ = st.text_input("ì´ë¦„", value=st.session_state.input_ì´ë¦„, placeholder="í™ê¸¸ë™", key="name_input")
        ì„±ë³„ = st.radio("ì„±ë³„", ["ë‚¨ì„±", "ì—¬ì„±"], horizontal=True, index=0 if st.session_state.input_ì„±ë³„ == "ë‚¨ì„±" else 1)
        ìƒë…„ì›”ì¼ = st.date_input(
            "ìƒë…„ì›”ì¼", 
            st.session_state.input_ìƒë…„ì›”ì¼,
            min_value=datetime(1900, 1, 1),
            max_value=datetime(2030, 12, 31)
        )
    
    with col2:
        ì‹œê°„_col1, ì‹œê°„_col2 = st.columns(2)
        with ì‹œê°„_col1:
            ì‹œ = st.number_input("ì‹œ", min_value=0, max_value=23, value=st.session_state.input_ì‹œ)
        with ì‹œê°„_col2:
            ë¶„ = st.number_input("ë¶„", min_value=0, max_value=59, value=st.session_state.input_ë¶„)
        
        # ìŒë ¥/ì–‘ë ¥ + ìœ¤ë‹¬ ì²´í¬ë°•ìŠ¤ë¥¼ í•œ ì¤„ì— ë°°ì¹˜
        ìŒì–‘ë ¥ = st.radio("ìŒë ¥/ì–‘ë ¥", ["ì–‘ë ¥", "ìŒë ¥"], horizontal=True, index=0 if st.session_state.input_ìŒì–‘ë ¥ == "ì–‘ë ¥" else 1)
        
        # ìŒë ¥ ì„ íƒ ì‹œì—ë§Œ ìœ¤ë‹¬ ì²´í¬ë°•ìŠ¤ í‘œì‹œ (ë°”ë¡œ ì•„ë˜ì—)
        if ìŒì–‘ë ¥ == "ìŒë ¥":
            ìœ¤ë‹¬ = st.checkbox("â˜‘ ìœ¤ë‹¬ (ìŒë ¥ ìƒì¼ì´ ìœ¤ë‹¬ì¸ ê²½ìš° ì²´í¬)", value=st.session_state.input_ìœ¤ë‹¬)
        else:
            ìœ¤ë‹¬ = False
    
    st.divider()
    
    # ë²„íŠ¼ ì˜ì—­ (ì´ë¯¸ì§€ ìƒì„± + GPTìš© í…ìŠ¤íŠ¸ + ì´ˆê¸°í™”)
    btn_col1, btn_col2, btn_col3 = st.columns([2, 2, 1])
    
    with btn_col1:
        ìƒì„±_ë²„íŠ¼ = st.button("ğŸ¯ ì´ë¯¸ì§€ ìƒì„±", type="primary", use_container_width=True)
    
    with btn_col2:
        GPT_ë²„íŠ¼ = st.button("ğŸ“‹ GPTìš© í…ìŠ¤íŠ¸", type="secondary", use_container_width=True)
    
    with btn_col3:
        ì´ˆê¸°í™”_ë²„íŠ¼ = st.button("ğŸ”„ ì´ˆê¸°í™”", type="secondary", use_container_width=True)
    
    # ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì‹œ
    if ì´ˆê¸°í™”_ë²„íŠ¼:
        st.session_state.input_ì´ë¦„ = ""
        st.session_state.input_ìƒë…„ì›”ì¼ = datetime(1990, 1, 1)
        st.session_state.input_ì‹œ = 12
        st.session_state.input_ë¶„ = 0
        st.session_state.input_ì„±ë³„ = "ë‚¨ì„±"
        st.session_state.input_ìŒì–‘ë ¥ = "ì–‘ë ¥"
        st.session_state.input_ìœ¤ë‹¬ = False
        st.session_state.ìƒì„±ëœ_ì´ë¯¸ì§€ = {}
        if 'gpt_text' in st.session_state:
            del st.session_state.gpt_text
        st.rerun()
    
    # GPTìš© í…ìŠ¤íŠ¸ ë²„íŠ¼ í´ë¦­ ì‹œ
    if GPT_ë²„íŠ¼:
        if not ì´ë¦„:
            st.error("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        else:
            with st.spinner("GPTìš© í…ìŠ¤íŠ¸ ìƒì„± ì¤‘..."):
                # ì…ë ¥ ë‚ ì§œ
                input_year = ìƒë…„ì›”ì¼.year
                input_month = ìƒë…„ì›”ì¼.month
                input_day = ìƒë…„ì›”ì¼.day
                
                # ìŒë ¥/ì–‘ë ¥ ë³€í™˜ (ìœ¤ë‹¬ ì§€ì›)
                if ìŒì–‘ë ¥ == "ìŒë ¥":
                    year, month, day = ìŒë ¥_to_ì–‘ë ¥(input_year, input_month, input_day, ìœ¤ë‹¬)
                    ìŒë ¥_str = ìŒë ¥_ë¬¸ìì—´(input_year, input_month, input_day, ìœ¤ë‹¬)
                    ì–‘ë ¥_str = f"{year}-{month:02d}-{day:02d} {ì‹œ:02d}:{ë¶„:02d}"
                else:
                    year, month, day = input_year, input_month, input_day
                    ì–‘ë ¥_str = f"{year}-{month:02d}-{day:02d} {ì‹œ:02d}:{ë¶„:02d}"
                    ìŒë ¥_year, ìŒë ¥_month, ìŒë ¥_day, ìŒë ¥_ìœ¤ë‹¬ = ì–‘ë ¥_to_ìŒë ¥(year, month, day)
                    ìŒë ¥_str = ìŒë ¥_ë¬¸ìì—´(ìŒë ¥_year, ìŒë ¥_month, ìŒë ¥_day, ìŒë ¥_ìœ¤ë‹¬)
                
                # ì‚¬ì£¼ ê³„ì‚°
                ì‚¬ì£¼ = calc_ì‚¬ì£¼(year, month, day, ì‹œ, ë¶„)
                
                # ë‚˜ì´ ê³„ì‚°
                today = datetime.now()
                ë‚˜ì´ = today.year - year + 1
                
                # ê¸°ë³¸ì •ë³´
                ê¸°ë³¸ì •ë³´ = {
                    'ì´ë¦„': ì´ë¦„,
                    'ì„±ë³„': ì„±ë³„,
                    'ë‚˜ì´': ë‚˜ì´,
                    'ì–‘ë ¥': ì–‘ë ¥_str,
                    'ìŒë ¥': ìŒë ¥_str,
                }
                
                gender = 'ë‚¨' if ì„±ë³„ == 'ë‚¨ì„±' else 'ì—¬'
                ì‹ ì‚´_data = calc_ì‹ ì‚´(ì‚¬ì£¼, gender)
                ëŒ€ìš´_data = calc_ëŒ€ìš´(year, month, day, ì‹œ, ë¶„, gender)
                ì„¸ìš´_data = calc_ì„¸ìš´(year, month, day, ì‹œ, ë¶„)
                ì›”ìš´_data = calc_ì›”ìš´(year, month, day, ì‹œ, ë¶„)
                
                # GPTìš© í…ìŠ¤íŠ¸ ìƒì„±
                gpt_text = generate_gpt_text(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, gender, ëŒ€ìš´_data, ì„¸ìš´_data, ì›”ìš´_data, ì‹ ì‚´_data)
                st.session_state.gpt_text = gpt_text
                st.session_state.gpt_ì´ë¦„ = ì´ë¦„
    
    # GPTìš© í…ìŠ¤íŠ¸ í‘œì‹œ
    if 'gpt_text' in st.session_state:
        st.divider()
        st.subheader(f"ğŸ“‹ {st.session_state.gpt_ì´ë¦„}ë‹˜ GPTìš© ë°ì´í„°")
        
        # ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì»¨í…Œì´ë„ˆ (height ì œí•œ)
        with st.container(height=300):
            st.code(st.session_state.gpt_text, language=None)
        
        st.download_button(
            label="ğŸ“¥ í…ìŠ¤íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ",
            data=st.session_state.gpt_text,
            file_name=f"{st.session_state.gpt_ì´ë¦„}_ì‚¬ì£¼ë°ì´í„°.txt",
            mime="text/plain",
            use_container_width=True
        )
    
    if ìƒì„±_ë²„íŠ¼:
        if not ì´ë¦„:
            st.error("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        else:
            with st.spinner("ì´ë¯¸ì§€ ìƒì„± ì¤‘..."):
                # ì…ë ¥ ë‚ ì§œ
                input_year = ìƒë…„ì›”ì¼.year
                input_month = ìƒë…„ì›”ì¼.month
                input_day = ìƒë…„ì›”ì¼.day
                
                # ìŒë ¥/ì–‘ë ¥ ë³€í™˜ (ìœ¤ë‹¬ ì§€ì›)
                if ìŒì–‘ë ¥ == "ìŒë ¥":
                    year, month, day = ìŒë ¥_to_ì–‘ë ¥(input_year, input_month, input_day, ìœ¤ë‹¬)
                    ìŒë ¥_str = ìŒë ¥_ë¬¸ìì—´(input_year, input_month, input_day, ìœ¤ë‹¬)
                    ì–‘ë ¥_str = f"{year}-{month:02d}-{day:02d} {ì‹œ:02d}:{ë¶„:02d}"
                else:
                    year, month, day = input_year, input_month, input_day
                    ì–‘ë ¥_str = f"{year}-{month:02d}-{day:02d} {ì‹œ:02d}:{ë¶„:02d}"
                    ìŒë ¥_year, ìŒë ¥_month, ìŒë ¥_day, ìŒë ¥_ìœ¤ë‹¬ = ì–‘ë ¥_to_ìŒë ¥(year, month, day)
                    ìŒë ¥_str = ìŒë ¥_ë¬¸ìì—´(ìŒë ¥_year, ìŒë ¥_month, ìŒë ¥_day, ìŒë ¥_ìœ¤ë‹¬)
                
                # ì‚¬ì£¼ ê³„ì‚°
                ì‚¬ì£¼ = calc_ì‚¬ì£¼(year, month, day, ì‹œ, ë¶„)
                
                # ë‚˜ì´ ê³„ì‚°
                today = datetime.now()
                ë‚˜ì´ = today.year - year + 1
                
                # ê¸°ë³¸ì •ë³´
                ê¸°ë³¸ì •ë³´ = {
                    'ì´ë¦„': ì´ë¦„,
                    'ì„±ë³„': ì„±ë³„,
                    'ë‚˜ì´': ë‚˜ì´,
                    'ì–‘ë ¥': ì–‘ë ¥_str,
                    'ìŒë ¥': ìŒë ¥_str,
                }
                
                gender = 'ë‚¨' if ì„±ë³„ == 'ë‚¨ì„±' else 'ì—¬'
                ì‹ ì‚´_data = calc_ì‹ ì‚´(ì‚¬ì£¼, gender)
                
                # ìƒì„±ëœ ì´ë¯¸ì§€ ê²½ë¡œ ì €ì¥ (session_stateì— ì €ì¥)
                ìƒì„±ëœ_ì´ë¯¸ì§€ = {}
                
                # ì²´í¬ëœ ì´ë¯¸ì§€ë§Œ ìƒì„±
                if ì›êµ­í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ì›êµ­í‘œ.png"
                    create_ì›êµ­í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path, ì‹ ì‚´_data, ZODIAC_PATH)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['01_ì›êµ­í‘œ'] = path
                
                if ëŒ€ìš´í‘œ_ì²´í¬:
                    ëŒ€ìš´_data = calc_ëŒ€ìš´(year, month, day, ì‹œ, ë¶„, gender)
                    path = f"/tmp/{ì´ë¦„}_ëŒ€ìš´í‘œ.png"
                    create_ëŒ€ìš´í‘œ(ëŒ€ìš´_data, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['02_ëŒ€ìš´í‘œ'] = path
                
                if ì„¸ìš´í‘œ_ì²´í¬:
                    ì„¸ìš´_data = calc_ì„¸ìš´(year, month, day, ì‹œ, ë¶„)
                    path = f"/tmp/{ì´ë¦„}_ì„¸ìš´í‘œ.png"
                    create_ì„¸ìš´í‘œ(ì„¸ìš´_data, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['03_ì„¸ìš´í‘œ'] = path
                
                if ì›”ìš´í‘œ_ì²´í¬:
                    ì›”ìš´_data = calc_ì›”ìš´(year, month, day, ì‹œ, ë¶„)
                    path = f"/tmp/{ì´ë¦„}_ì›”ìš´í‘œ.png"
                    create_ì›”ìš´í‘œ(ì›”ìš´_data, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['04_ì›”ìš´í‘œ'] = path
                
                if ì˜¤í–‰ì°¨íŠ¸_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ì˜¤í–‰ë¶„ì„.png"
                    create_ì˜¤í–‰ì°¨íŠ¸(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['05_ì˜¤í–‰ë¶„ì„'] = path
                
                if ì‹­ì„±í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ì‹­ì„±í‘œ.png"
                    create_ì‹­ì„±í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['06_ì‹­ì„±í‘œ'] = path
                
                if ì‹ ì‚´í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ì‹ ì‚´í‘œ.png"
                    create_ì‹ ì‚´í‘œ(ì‹ ì‚´_data, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['07_ì‹ ì‚´í‘œ'] = path
                
                if ìš´ì„±í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_12ìš´ì„±í‘œ.png"
                    create_12ìš´ì„±í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['08_12ìš´ì„±í‘œ'] = path
                
                if ì§€ì¥ê°„í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ì§€ì¥ê°„í‘œ.png"
                    create_ì§€ì¥ê°„í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['09_ì§€ì¥ê°„í‘œ'] = path
                
                if í•©ì¶©í˜•íŒŒí•´í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_í•©ì¶©í˜•íŒŒí•´í‘œ.png"
                    create_í•©ì¶©í˜•íŒŒí•´í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['10_í•©ì¶©í˜•íŒŒí•´í‘œ'] = path
                
                if ê¶ì„±í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ê¶ì„±í‘œ.png"
                    create_ê¶ì„±í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['11_ê¶ì„±í‘œ'] = path
                
                if ìœ¡ì¹œí‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ìœ¡ì¹œí‘œ.png"
                    create_ìœ¡ì¹œí‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, gender, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['12_ìœ¡ì¹œí‘œ'] = path
                
                if ë‚©ìŒì˜¤í–‰í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ë‚©ìŒì˜¤í–‰í‘œ.png"
                    create_ë‚©ìŒì˜¤í–‰í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['13_ë‚©ìŒì˜¤í–‰í‘œ'] = path
                
                if ê²©êµ­í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ê²©êµ­í‘œ.png"
                    create_ê²©êµ­í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['14_ê²©êµ­í‘œ'] = path
                
                if ê³µë§í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ê³µë§í‘œ.png"
                    create_ê³µë§í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['15_ê³µë§í‘œ'] = path
                
                if ìš©ì‹ í‘œ_ì²´í¬:
                    path = f"/tmp/{ì´ë¦„}_ìš©ì‹ í‘œ.png"
                    create_ìš©ì‹ í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                    ìƒì„±ëœ_ì´ë¯¸ì§€['16_ìš©ì‹ í‘œ'] = path
                
                st.success(f"âœ… ì´ë¯¸ì§€ ìƒì„± ì™„ë£Œ! ({len(ìƒì„±ëœ_ì´ë¯¸ì§€)}ê°œ)")
                
                # ============================================
                # ì „ì²´ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ìƒë‹¨)
                # ============================================
                if len(ìƒì„±ëœ_ì´ë¯¸ì§€) > 0:
                    zip_buffer = io.BytesIO()
                    with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zf:
                        for íŒŒì¼ëª…, ê²½ë¡œ in ìƒì„±ëœ_ì´ë¯¸ì§€.items():
                            zf.write(ê²½ë¡œ, f"{íŒŒì¼ëª…}.png")
                    
                    zip_buffer.seek(0)
                    st.download_button(
                        label=f"ğŸ“¦ ì „ì²´ ë‹¤ìš´ë¡œë“œ ({len(ìƒì„±ëœ_ì´ë¯¸ì§€)}ê°œ ZIP)",
                        data=zip_buffer,
                        file_name=f"{ì´ë¦„}_ì‚¬ì£¼ë¶„ì„.zip",
                        mime="application/zip",
                        use_container_width=True,
                        key="download_ì „ì²´_zip"
                    )
                
                st.divider()
                
                # ============================================
                # ê°œë³„ ì´ë¯¸ì§€ í‘œì‹œ
                # ============================================
                if '01_ì›êµ­í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ“Š ì›êµ­í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['01_ì›êµ­í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ì›êµ­í‘œ")
                
                if '02_ëŒ€ìš´í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ“ˆ ëŒ€ìš´í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['02_ëŒ€ìš´í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ëŒ€ìš´í‘œ")
                
                if '03_ì„¸ìš´í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ“… ì„¸ìš´í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['03_ì„¸ìš´í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ì„¸ìš´í‘œ")
                
                if '04_ì›”ìš´í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ—“ï¸ ì›”ìš´í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['04_ì›”ìš´í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ì›”ìš´í‘œ")
                
                if '05_ì˜¤í–‰ë¶„ì„' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ”¥ ì˜¤í–‰ ë¶„ì„")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['05_ì˜¤í–‰ë¶„ì„'], caption=f"{ì´ë¦„}ë‹˜ ì˜¤í–‰ë¶„ì„")
                
                if '06_ì‹­ì„±í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("â­ ì‹­ì„±í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['06_ì‹­ì„±í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ì‹­ì„±í‘œ")
                
                if '07_ì‹ ì‚´í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ”® ì‹ ì‚´í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['07_ì‹ ì‚´í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ì‹ ì‚´í‘œ")
                
                if '08_12ìš´ì„±í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ”„ 12ìš´ì„±í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['08_12ìš´ì„±í‘œ'], caption=f"{ì´ë¦„}ë‹˜ 12ìš´ì„±í‘œ")
                
                if '09_ì§€ì¥ê°„í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ“‹ ì§€ì¥ê°„í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['09_ì§€ì¥ê°„í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ì§€ì¥ê°„í‘œ")
                
                if '10_í•©ì¶©í˜•íŒŒí•´í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("âš¡ í•©ì¶©í˜•íŒŒí•´í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['10_í•©ì¶©í˜•íŒŒí•´í‘œ'], caption=f"{ì´ë¦„}ë‹˜ í•©ì¶©í˜•íŒŒí•´í‘œ")
                
                if '11_ê¶ì„±í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ  ê¶ì„±í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['11_ê¶ì„±í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ê¶ì„±í‘œ")
                
                if '12_ìœ¡ì¹œí‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ìœ¡ì¹œí‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['12_ìœ¡ì¹œí‘œ'], caption=f"{ì´ë¦„}ë‹˜ ìœ¡ì¹œí‘œ")
                
                if '13_ë‚©ìŒì˜¤í–‰í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸµ ë‚©ìŒì˜¤í–‰í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['13_ë‚©ìŒì˜¤í–‰í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ë‚©ìŒì˜¤í–‰í‘œ")
                
                if '14_ê²©êµ­í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ¯ ê²©êµ­í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['14_ê²©êµ­í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ê²©êµ­í‘œ")
                
                if '15_ê³µë§í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ•³ï¸ ê³µë§í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['15_ê³µë§í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ê³µë§í‘œ")
                
                if '16_ìš©ì‹ í‘œ' in ìƒì„±ëœ_ì´ë¯¸ì§€:
                    st.subheader("ğŸ¯ ìš©ì‹ í‘œ")
                    st.image(ìƒì„±ëœ_ì´ë¯¸ì§€['16_ìš©ì‹ í‘œ'], caption=f"{ì´ë¦„}ë‹˜ ìš©ì‹ í‘œ")

# ============================================
# íƒ­2: ì—‘ì…€ ì¼ê´„ ì²˜ë¦¬
# ============================================
with tab2:
    st.subheader("ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ")
    
    # ìƒ˜í”Œ ë‹¤ìš´ë¡œë“œ
    sample_data = {
        'ì´ë¦„': ['í™ê¸¸ë™', 'ê¹€ì² ìˆ˜'],
        'ì„±ë³„': ['ë‚¨ì„±', 'ì—¬ì„±'],
        'ìƒë…„': [1990, 1985],
        'ìƒì›”': [5, 12],
        'ìƒì¼': [15, 3],
        'ì‹œ': [14, 8],
        'ë¶„': [30, 0],
        'ìŒì–‘ë ¥': ['ì–‘ë ¥', 'ìŒë ¥'],
        'ìœ¤ë‹¬': ['', 'O'],  # ìŒë ¥ì¼ ë•Œë§Œ O í‘œì‹œ
    }
    sample_df = pd.DataFrame(sample_data)
    
    buffer = io.BytesIO()
    sample_df.to_excel(buffer, index=False, engine='openpyxl')
    buffer.seek(0)
    
    st.download_button(
        label="ğŸ“‹ ìƒ˜í”Œ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ",
        data=buffer,
        file_name="sample_input.xlsx",
        mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    )
    
    st.info("ğŸ’¡ **ìœ¤ë‹¬ ì…ë ¥ ë°©ë²•**: ìŒë ¥ ìƒì¼ì´ ìœ¤ë‹¬ì¸ ê²½ìš° 'ìœ¤ë‹¬' ì»¬ëŸ¼ì— 'O' ì…ë ¥")
    
    st.divider()
    
    uploaded_file = st.file_uploader("ì—‘ì…€ íŒŒì¼ ì„ íƒ", type=['xlsx', 'xls'])
    
    if uploaded_file:
        df = pd.read_excel(uploaded_file)
        
        # ìœ¤ë‹¬ ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ì¶”ê°€
        if 'ìœ¤ë‹¬' not in df.columns:
            df['ìœ¤ë‹¬'] = ''
        
        st.write(f"**{len(df)}ëª… ë°ì´í„° í™•ì¸:**")
        st.dataframe(df, use_container_width=True)
        
        if st.button("ğŸ¯ ì¼ê´„ ìƒì„±", type="primary", use_container_width=True):
            progress = st.progress(0)
            status = st.empty()
            
            zip_buffer = io.BytesIO()
            
            with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zf:
                for idx, row in df.iterrows():
                    status.text(f"ì²˜ë¦¬ ì¤‘: {row['ì´ë¦„']} ({idx+1}/{len(df)})")
                    
                    input_year = int(row['ìƒë…„'])
                    input_month = int(row['ìƒì›”'])
                    input_day = int(row['ìƒì¼'])
                    
                    # ìœ¤ë‹¬ ì—¬ë¶€ í™•ì¸ (O, o, â—‹, 1, True ë“±)
                    ìœ¤ë‹¬_ê°’ = str(row.get('ìœ¤ë‹¬', '')).strip().upper()
                    ìœ¤ë‹¬ = ìœ¤ë‹¬_ê°’ in ['O', 'â—‹', '1', 'TRUE', 'Y', 'YES', 'ìœ¤ë‹¬']
                    
                    if row['ìŒì–‘ë ¥'] == "ìŒë ¥":
                        year, month, day = ìŒë ¥_to_ì–‘ë ¥(input_year, input_month, input_day, ìœ¤ë‹¬)
                        ìŒë ¥_str = ìŒë ¥_ë¬¸ìì—´(input_year, input_month, input_day, ìœ¤ë‹¬)
                        ì–‘ë ¥_str = f"{year}-{month:02d}-{day:02d} {int(row['ì‹œ']):02d}:{int(row['ë¶„']):02d}"
                    else:
                        year, month, day = input_year, input_month, input_day
                        ì–‘ë ¥_str = f"{year}-{month:02d}-{day:02d} {int(row['ì‹œ']):02d}:{int(row['ë¶„']):02d}"
                        ìŒë ¥_year, ìŒë ¥_month, ìŒë ¥_day, ìŒë ¥_ìœ¤ë‹¬ = ì–‘ë ¥_to_ìŒë ¥(year, month, day)
                        ìŒë ¥_str = ìŒë ¥_ë¬¸ìì—´(ìŒë ¥_year, ìŒë ¥_month, ìŒë ¥_day, ìŒë ¥_ìœ¤ë‹¬)
                    
                    ì‚¬ì£¼ = calc_ì‚¬ì£¼(year, month, day, int(row['ì‹œ']), int(row['ë¶„']))
                    ë‚˜ì´ = datetime.now().year - year + 1
                    
                    ê¸°ë³¸ì •ë³´ = {
                        'ì´ë¦„': row['ì´ë¦„'],
                        'ì„±ë³„': row['ì„±ë³„'],
                        'ë‚˜ì´': ë‚˜ì´,
                        'ì–‘ë ¥': ì–‘ë ¥_str,
                        'ìŒë ¥': ìŒë ¥_str,
                    }
                    
                    gender = 'ë‚¨' if row['ì„±ë³„'] == 'ë‚¨ì„±' else 'ì—¬'
                    ì‹ ì‚´_data = calc_ì‹ ì‚´(ì‚¬ì£¼, gender)
                    
                    folder_name = f"{row['ì´ë¦„']}_{row['ìƒë…„']}-{row['ìƒì›”']:02d}-{row['ìƒì¼']:02d}"
                    
                    # ì²´í¬ëœ ì´ë¯¸ì§€ë§Œ ìƒì„±
                    if ì›êµ­í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ì›êµ­í‘œ.png"
                        create_ì›êµ­í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path, ì‹ ì‚´_data, ZODIAC_PATH)
                        zf.write(path, f"{folder_name}/01_ì›êµ­í‘œ.png")
                    
                    if ëŒ€ìš´í‘œ_ì²´í¬:
                        ëŒ€ìš´_data = calc_ëŒ€ìš´(year, month, day, int(row['ì‹œ']), int(row['ë¶„']), gender)
                        path = f"/tmp/{row['ì´ë¦„']}_ëŒ€ìš´í‘œ.png"
                        create_ëŒ€ìš´í‘œ(ëŒ€ìš´_data, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/02_ëŒ€ìš´í‘œ.png")
                    
                    if ì„¸ìš´í‘œ_ì²´í¬:
                        ì„¸ìš´_data = calc_ì„¸ìš´(year, month, day, int(row['ì‹œ']), int(row['ë¶„']))
                        path = f"/tmp/{row['ì´ë¦„']}_ì„¸ìš´í‘œ.png"
                        create_ì„¸ìš´í‘œ(ì„¸ìš´_data, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/03_ì„¸ìš´í‘œ.png")
                    
                    if ì›”ìš´í‘œ_ì²´í¬:
                        ì›”ìš´_data = calc_ì›”ìš´(year, month, day, int(row['ì‹œ']), int(row['ë¶„']))
                        path = f"/tmp/{row['ì´ë¦„']}_ì›”ìš´í‘œ.png"
                        create_ì›”ìš´í‘œ(ì›”ìš´_data, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/04_ì›”ìš´í‘œ.png")
                    
                    if ì˜¤í–‰ì°¨íŠ¸_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ì˜¤í–‰ë¶„ì„.png"
                        create_ì˜¤í–‰ì°¨íŠ¸(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/05_ì˜¤í–‰ë¶„ì„.png")
                    
                    if ì‹­ì„±í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ì‹­ì„±í‘œ.png"
                        create_ì‹­ì„±í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/06_ì‹­ì„±í‘œ.png")
                    
                    if ì‹ ì‚´í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ì‹ ì‚´í‘œ.png"
                        create_ì‹ ì‚´í‘œ(ì‹ ì‚´_data, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/07_ì‹ ì‚´í‘œ.png")
                    
                    if ìš´ì„±í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_12ìš´ì„±í‘œ.png"
                        create_12ìš´ì„±í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/08_12ìš´ì„±í‘œ.png")
                    
                    if ì§€ì¥ê°„í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ì§€ì¥ê°„í‘œ.png"
                        create_ì§€ì¥ê°„í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/09_ì§€ì¥ê°„í‘œ.png")
                    
                    if í•©ì¶©í˜•íŒŒí•´í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_í•©ì¶©í˜•íŒŒí•´í‘œ.png"
                        create_í•©ì¶©í˜•íŒŒí•´í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/10_í•©ì¶©í˜•íŒŒí•´í‘œ.png")
                    
                    if ê¶ì„±í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ê¶ì„±í‘œ.png"
                        create_ê¶ì„±í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/11_ê¶ì„±í‘œ.png")
                    
                    if ìœ¡ì¹œí‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ìœ¡ì¹œí‘œ.png"
                        create_ìœ¡ì¹œí‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, gender, path)
                        zf.write(path, f"{folder_name}/12_ìœ¡ì¹œí‘œ.png")
                    
                    if ë‚©ìŒì˜¤í–‰í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ë‚©ìŒì˜¤í–‰í‘œ.png"
                        create_ë‚©ìŒì˜¤í–‰í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/13_ë‚©ìŒì˜¤í–‰í‘œ.png")
                    
                    if ê²©êµ­í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ê²©êµ­í‘œ.png"
                        create_ê²©êµ­í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/14_ê²©êµ­í‘œ.png")
                    
                    if ê³µë§í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ê³µë§í‘œ.png"
                        create_ê³µë§í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/15_ê³µë§í‘œ.png")
                    
                    if ìš©ì‹ í‘œ_ì²´í¬:
                        path = f"/tmp/{row['ì´ë¦„']}_ìš©ì‹ í‘œ.png"
                        create_ìš©ì‹ í‘œ(ì‚¬ì£¼, ê¸°ë³¸ì •ë³´, path)
                        zf.write(path, f"{folder_name}/16_ìš©ì‹ í‘œ.png")
                    
                    progress.progress((idx + 1) / len(df))
            
            status.text("âœ… ì™„ë£Œ!")
            
            zip_buffer.seek(0)
            st.download_button(
                label="ğŸ“¥ ì „ì²´ ë‹¤ìš´ë¡œë“œ (ZIP)",
                data=zip_buffer,
                file_name="ì‚¬ì£¼_ì´ë¯¸ì§€_ê²°ê³¼.zip",
                mime="application/zip",
                use_container_width=True
            )

# ============================================
# íƒ­3: ì¼ì§„í‘œ
# ============================================
with tab3:
    st.subheader("ğŸ“… ì¼ì§„í‘œ ìƒì„±")
    st.write("12ê°œì›”ì¹˜ ì¼ì§„í‘œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.")
    
    col1, col2 = st.columns(2)
    
    with col1:
        ì¼ì§„_ì´ë¦„ = st.text_input("ì´ë¦„ (ì„ íƒ)", placeholder="í™ê¸¸ë™", key="ilzin_name")
    
    with col2:
        ì¼ì§„_ë…„ë„ = st.number_input("ë…„ë„", min_value=1900, max_value=2100, value=datetime.now().year, key="ilzin_year")
    
    # ì‹œì‘ ì›” ì„ íƒ
    ì‹œì‘ì›” = st.selectbox("ì‹œì‘ ì›”", range(1, 13), index=datetime.now().month - 1, key="ilzin_start_month")
    
    st.divider()
    
    if st.button("ğŸ“… ì¼ì§„í‘œ ìƒì„±", type="primary", use_container_width=True, key="btn_ilzin"):
        with st.spinner("ì¼ì§„í‘œ ìƒì„± ì¤‘..."):
            
            # ê¸°ë³¸ì •ë³´ (ì´ë¦„ì´ ìˆì„ ê²½ìš°)
            ê¸°ë³¸ì •ë³´ = {'ì´ë¦„': ì¼ì§„_ì´ë¦„} if ì¼ì§„_ì´ë¦„ else None
            
            # 12ê°œì›”ì¹˜ ìƒì„±
            ìƒì„±ëœ_ì¼ì§„ = {}
            
            for i in range(12):
                # ì›” ê³„ì‚° (ì‹œì‘ì›”ë¶€í„° 12ê°œì›”)
                target_month = ì‹œì‘ì›” + i
                target_year = ì¼ì§„_ë…„ë„
                
                if target_month > 12:
                    target_month -= 12
                    target_year += 1
                
                íŒŒì¼ëª… = f"{target_year}ë…„_{target_month:02d}ì›”_ì¼ì§„í‘œ"
                path = f"/tmp/{íŒŒì¼ëª…}.png"
                
                create_ì¼ì§„í‘œ(target_year, target_month, ê¸°ë³¸ì •ë³´=ê¸°ë³¸ì •ë³´, output_path=path)
                ìƒì„±ëœ_ì¼ì§„[íŒŒì¼ëª…] = path
            
            st.success(f"âœ… ì¼ì§„í‘œ 12ê°œì›” ìƒì„± ì™„ë£Œ!")
            
            # ============================================
            # ì „ì²´ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ (ìƒë‹¨)
            # ============================================
            zip_buffer = io.BytesIO()
            with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zf:
                for íŒŒì¼ëª…, ê²½ë¡œ in ìƒì„±ëœ_ì¼ì§„.items():
                    zf.write(ê²½ë¡œ, f"{íŒŒì¼ëª…}.png")
            
            zip_buffer.seek(0)
            
            ë‹¤ìš´ë¡œë“œ_íŒŒì¼ëª… = f"{ì¼ì§„_ì´ë¦„}_ì¼ì§„í‘œ_12ê°œì›”.zip" if ì¼ì§„_ì´ë¦„ else f"{ì¼ì§„_ë…„ë„}ë…„_ì¼ì§„í‘œ_12ê°œì›”.zip"
            
            st.download_button(
                label="ğŸ“¦ ì „ì²´ ë‹¤ìš´ë¡œë“œ (12ê°œì›” ZIP)",
                data=zip_buffer,
                file_name=ë‹¤ìš´ë¡œë“œ_íŒŒì¼ëª…,
                mime="application/zip",
                use_container_width=True,
                key="download_ì¼ì§„_zip"
            )
            
            st.divider()
            
            # ============================================
            # ê°œë³„ ì›” ì´ë¯¸ì§€ í‘œì‹œ
            # ============================================
            for íŒŒì¼ëª…, ê²½ë¡œ in ìƒì„±ëœ_ì¼ì§„.items():
                st.subheader(f"ğŸ“… {íŒŒì¼ëª….replace('_', ' ')}")
                st.image(ê²½ë¡œ, caption=íŒŒì¼ëª…)

