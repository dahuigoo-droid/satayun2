# 만세력 계산기 v1
# 샘플 데이터로 로직 검증

# ============================================
# 기본 데이터 테이블
# ============================================

# 천간 (10개)
천간 = ['갑', '을', '병', '정', '무', '기', '경', '신', '임', '계']
천간_한자 = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸']
천간_오행 = ['목', '목', '화', '화', '토', '토', '금', '금', '수', '수']
천간_음양 = ['양', '음', '양', '음', '양', '음', '양', '음', '양', '음']

# 지지 (12개)
지지 = ['자', '축', '인', '묘', '진', '사', '오', '미', '신', '유', '술', '해']
지지_한자 = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥']
지지_오행 = ['수', '토', '목', '목', '토', '화', '화', '토', '금', '금', '토', '수']
지지_음양 = ['양', '음', '양', '음', '양', '음', '양', '음', '양', '음', '양', '음']

# 60갑자
def get_60갑자(index):
    """60갑자 인덱스로 천간/지지 반환"""
    천간_idx = index % 10
    지지_idx = index % 12
    return 천간[천간_idx], 지지[지지_idx]

# ============================================
# 년주 계산
# ============================================
def calc_년주(year, month, day):
    """
    년주 계산 - 입춘 기준
    입춘 전이면 전년도로 계산
    입춘: 대략 2월 4일 (정확한 계산은 별도 필요)
    """
    # 입춘 전이면 전년도
    if month == 1 or (month == 2 and day < 4):
        year = year - 1
    
    # 1984년 = 갑자년 (index 0)
    index = (year - 1984) % 60
    if index < 0:
        index += 60
    
    천간_idx = index % 10
    지지_idx = index % 12
    
    return 천간[천간_idx], 지지[지지_idx]

# ============================================
# 월주 계산 - 오호둔갑법
# ============================================
월주_천간_시작 = {
    '갑': 2, '기': 2,  # 갑기년 -> 병인월 시작 (병=2)
    '을': 4, '경': 4,  # 을경년 -> 무인월 시작 (무=4)
    '병': 6, '신': 6,  # 병신년 -> 경인월 시작 (경=6)
    '정': 8, '임': 8,  # 정임년 -> 임인월 시작 (임=8)
    '무': 0, '계': 0,  # 무계년 -> 갑인월 시작 (갑=0)
}

# 절기 기준 월 (대략적인 양력 날짜)
절기_시작 = {
    1: (2, 4),   # 인월: 입춘 ~2/4
    2: (3, 6),   # 묘월: 경칩 ~3/6
    3: (4, 5),   # 진월: 청명 ~4/5
    4: (5, 6),   # 사월: 입하 ~5/6
    5: (6, 6),   # 오월: 망종 ~6/6
    6: (7, 7),   # 미월: 소서 ~7/7
    7: (8, 8),   # 신월: 입추 ~8/8
    8: (9, 8),   # 유월: 백로 ~9/8
    9: (10, 8),  # 술월: 한로 ~10/8
    10: (11, 7), # 해월: 입동 ~11/7
    11: (12, 7), # 자월: 대설 ~12/7
    12: (1, 6),  # 축월: 소한 ~1/6
}

def get_월_from_양력(month, day):
    """양력 월일로 절기 기준 월 계산 (인월=1, 묘월=2, ...)"""
    for 월, (시작월, 시작일) in 절기_시작.items():
        다음월 = (월 % 12) + 1
        다음_시작월, 다음_시작일 = 절기_시작[다음월]
        
        if 시작월 == month:
            if day >= 시작일:
                return 월
        
    # 간단한 매핑 (대략적)
    if month == 2 and day >= 4:
        return 1  # 인월
    elif month == 3 and day >= 6:
        return 2  # 묘월
    elif month == 4 and day >= 5:
        return 3  # 진월
    elif month == 5 and day >= 6:
        return 4  # 사월
    elif month == 6 and day >= 6:
        return 5  # 오월
    elif month == 7 and day >= 7:
        return 6  # 미월
    elif month == 8 and day >= 8:
        return 7  # 신월
    elif month == 9 and day >= 8:
        return 8  # 유월
    elif month == 10 and day >= 8:
        return 9  # 술월
    elif month == 11 and day >= 7:
        return 10 # 해월
    elif month == 12 and day >= 7:
        return 11 # 자월
    elif month == 1 and day >= 6:
        return 12 # 축월
    else:
        # 이전 월
        if month == 1:
            return 11  # 자월
        elif month == 2:
            return 12  # 축월
        elif month == 3:
            return 1   # 인월
        elif month == 4:
            return 2   # 묘월
        elif month == 5:
            return 3   # 진월
        elif month == 6:
            return 4   # 사월
        elif month == 7:
            return 5   # 오월
        elif month == 8:
            return 6   # 미월
        elif month == 9:
            return 7   # 신월
        elif month == 10:
            return 8   # 유월
        elif month == 11:
            return 9   # 술월
        elif month == 12:
            return 10  # 해월

def calc_월주(년간, month, day):
    """월주 계산"""
    월_index = get_월_from_양력(month, day)  # 1=인월, 2=묘월, ...
    
    # 월지 계산 (인월=인(2), 묘월=묘(3), ...)
    지지_idx = (월_index + 1) % 12  # 인=2
    
    # 월간 계산 (오호둔갑)
    시작_천간 = 월주_천간_시작[년간]
    천간_idx = (시작_천간 + 월_index - 1) % 10
    
    return 천간[천간_idx], 지지[지지_idx]

# ============================================
# 일주 계산
# ============================================
from datetime import date

def calc_일주(year, month, day):
    """
    일주 계산 - 기준일로부터 날짜 차이
    기준일: 1900년 1월 1일 = 갑진일 (index 40)
    """
    기준일 = date(1900, 1, 1)
    기준일_갑자_index = 10  # 갑술 (역산으로 확인)
    
    대상일 = date(year, month, day)
    차이 = (대상일 - 기준일).days
    
    index = (기준일_갑자_index + 차이) % 60
    
    천간_idx = index % 10
    지지_idx = index % 12
    
    return 천간[천간_idx], 지지[지지_idx]

# ============================================
# 시주 계산 - 오서둔갑법
# ============================================
시주_천간_시작 = {
    '갑': 0, '기': 0,  # 갑기일 -> 갑자시 시작
    '을': 2, '경': 2,  # 을경일 -> 병자시 시작
    '병': 4, '신': 4,  # 병신일 -> 무자시 시작
    '정': 6, '임': 6,  # 정임일 -> 경자시 시작
    '무': 8, '계': 8,  # 무계일 -> 임자시 시작
}

def get_시지_index(hour, minute=0):
    """시간으로 시지 인덱스 계산"""
    # 자시: 23:00~00:59, 축시: 01:00~02:59, ...
    total_minutes = hour * 60 + minute
    
    if total_minutes >= 23 * 60 or total_minutes < 1 * 60:
        return 0  # 자
    elif total_minutes < 3 * 60:
        return 1  # 축
    elif total_minutes < 5 * 60:
        return 2  # 인
    elif total_minutes < 7 * 60:
        return 3  # 묘
    elif total_minutes < 9 * 60:
        return 4  # 진
    elif total_minutes < 11 * 60:
        return 5  # 사
    elif total_minutes < 13 * 60:
        return 6  # 오
    elif total_minutes < 15 * 60:
        return 7  # 미
    elif total_minutes < 17 * 60:
        return 8  # 신
    elif total_minutes < 19 * 60:
        return 9  # 유
    elif total_minutes < 21 * 60:
        return 10 # 술
    else:
        return 11 # 해

def calc_시주(일간, hour, minute=0):
    """시주 계산"""
    지지_idx = get_시지_index(hour, minute)
    
    # 시간 천간 계산 (오서둔갑)
    시작_천간 = 시주_천간_시작[일간]
    천간_idx = (시작_천간 + 지지_idx) % 10
    
    return 천간[천간_idx], 지지[지지_idx]

# ============================================
# 십성 계산
# ============================================
오행_관계 = {
    # 일간오행: {대상오행: (같은음양, 다른음양)}
    '목': {'목': ('비견', '겁재'), '화': ('식신', '상관'), '토': ('편재', '정재'), '금': ('편관', '정관'), '수': ('편인', '정인')},
    '화': {'화': ('비견', '겁재'), '토': ('식신', '상관'), '금': ('편재', '정재'), '수': ('편관', '정관'), '목': ('편인', '정인')},
    '토': {'토': ('비견', '겁재'), '금': ('식신', '상관'), '수': ('편재', '정재'), '목': ('편관', '정관'), '화': ('편인', '정인')},
    '금': {'금': ('비견', '겁재'), '수': ('식신', '상관'), '목': ('편재', '정재'), '화': ('편관', '정관'), '토': ('편인', '정인')},
    '수': {'수': ('비견', '겁재'), '목': ('식신', '상관'), '화': ('편재', '정재'), '토': ('편관', '정관'), '금': ('편인', '정인')},
}

def calc_십성(일간, 대상, is_천간=True):
    """십성 계산"""
    일간_idx = 천간.index(일간)
    일간_오행 = 천간_오행[일간_idx]
    일간_음양 = 천간_음양[일간_idx]
    
    if is_천간:
        대상_idx = 천간.index(대상)
        대상_오행 = 천간_오행[대상_idx]
        대상_음양 = 천간_음양[대상_idx]
    else:
        # 지지는 지장간 본기 기준으로 계산
        본기 = 지장간_본기[대상]
        본기_idx = 천간.index(본기)
        대상_오행 = 천간_오행[본기_idx]
        대상_음양 = 천간_음양[본기_idx]
    
    관계 = 오행_관계[일간_오행][대상_오행]
    
    # 같은 음양이면 [0], 다른 음양이면 [1]
    if 일간_음양 == 대상_음양:
        return 관계[0]
    else:
        return 관계[1]

# ============================================
# 12운성 계산
# ============================================
# 일간별 12운성 시작 지지 (장생 위치)
운성_12 = ['장생', '목욕', '관대', '건록', '제왕', '쇠', '병', '사', '묘', '절', '태', '양']

# 양간: 순행, 음간: 역행
장생_위치 = {
    '갑': 11,  # 해
    '을': 6,   # 오
    '병': 2,   # 인
    '정': 9,   # 유
    '무': 2,   # 인
    '기': 9,   # 유
    '경': 5,   # 사
    '신': 0,   # 자
    '임': 8,   # 신
    '계': 3,   # 묘
}

def calc_12운성(일간, 지지_char):
    """12운성 계산"""
    일간_idx = 천간.index(일간)
    음양 = 천간_음양[일간_idx]
    지지_idx = 지지.index(지지_char)
    
    장생_지지 = 장생_위치[일간]
    
    if 음양 == '양':
        # 순행
        운성_idx = (지지_idx - 장생_지지) % 12
    else:
        # 역행
        운성_idx = (장생_지지 - 지지_idx) % 12
    
    return 운성_12[운성_idx]

# ============================================
# 지장간
# ============================================
지장간_표 = {
    '자': '임계',
    '축': '기신계',
    '인': '무병갑',
    '묘': '갑을',
    '진': '을계무',
    '사': '무경병',
    '오': '병기정',
    '미': '정을기',
    '신': '무임경',
    '유': '경신',
    '술': '신정무',
    '해': '무갑임',
}

# 지장간 본기 (가장 강한 기운 = 정기)
지장간_본기 = {
    '자': '계',  # 수
    '축': '기',  # 토
    '인': '갑',  # 목
    '묘': '을',  # 목
    '진': '무',  # 토
    '사': '병',  # 화
    '오': '정',  # 화  
    '미': '기',  # 토
    '신': '경',  # 금
    '유': '신',  # 금
    '술': '무',  # 토
    '해': '임',  # 수
}

def get_지장간(지지_char):
    """지장간 반환"""
    return 지장간_표.get(지지_char, '')

# ============================================
# 12신살 계산 (삼합 기준)
# ============================================
# 년지로 삼합 판단
년지_삼합 = {
    '인': '인오술', '오': '인오술', '술': '인오술',
    '사': '사유축', '유': '사유축', '축': '사유축',
    '신': '신자진', '자': '신자진', '진': '신자진',
    '해': '해묘미', '묘': '해묘미', '미': '해묘미',
}

# 삼합별 겁살 위치 (지지 인덱스)
겁살_위치 = {
    '인오술': 5,  # 사
    '사유축': 2,  # 인
    '신자진': 11, # 해
    '해묘미': 8,  # 신
}

# 12신살 순서 (겁살부터 시계방향)
신살_순서 = ['겁살', '재살', '천살', '지살', '연살', '월살', '망신', '장성', '반안', '역마', '육해', '화개']

def calc_12신살(년지, 대상_지지):
    """삼합 기준 12신살 계산"""
    삼합 = 년지_삼합[년지]
    겁살_지지_idx = 겁살_위치[삼합]
    대상_idx = 지지.index(대상_지지)
    
    # 겁살 위치에서 대상까지의 거리
    거리 = (대상_idx - 겁살_지지_idx) % 12
    
    return 신살_순서[거리]

# ============================================
# 오행 분석
# ============================================
def calc_오행_분석(사주_결과):
    """오행 개수 분석"""
    오행_count = {'목': 0, '화': 0, '토': 0, '금': 0, '수': 0}
    
    for 주 in ['년주', '월주', '일주', '시주']:
        간, 지 = 사주_결과[주]
        간_idx = 천간.index(간)
        지_idx = 지지.index(지)
        오행_count[천간_오행[간_idx]] += 1
        오행_count[지지_오행[지_idx]] += 1
    
    return 오행_count

# ============================================
# 전체 사주 계산
# ============================================
def calc_사주(year, month, day, hour, minute=0):
    """전체 사주 계산"""
    년간, 년지 = calc_년주(year, month, day)
    월간, 월지 = calc_월주(년간, month, day)
    일간, 일지 = calc_일주(year, month, day)
    시간, 시지 = calc_시주(일간, hour, minute)
    
    result = {
        '년주': (년간, 년지),
        '월주': (월간, 월지),
        '일주': (일간, 일지),
        '시주': (시간, 시지),
        '천간십성': {
            '년': calc_십성(일간, 년간, True),
            '월': calc_십성(일간, 월간, True),
            '일': '일간(나)',
            '시': calc_십성(일간, 시간, True),
        },
        '지지십성': {
            '년': calc_십성(일간, 년지, False),
            '월': calc_십성(일간, 월지, False),
            '일': calc_십성(일간, 일지, False),
            '시': calc_십성(일간, 시지, False),
        },
        '12운성': {
            '년': calc_12운성(일간, 년지),
            '월': calc_12운성(일간, 월지),
            '일': calc_12운성(일간, 일지),
            '시': calc_12운성(일간, 시지),
        },
        '지장간': {
            '년': get_지장간(년지),
            '월': get_지장간(월지),
            '일': get_지장간(일지),
            '시': get_지장간(시지),
        },
        '12신살': {
            '년': calc_12신살(년지, 년지),
            '월': calc_12신살(년지, 월지),
            '일': calc_12신살(년지, 일지),
            '시': calc_12신살(년지, 시지),
        },
        '오행': None,  # 나중에 계산
    }
    
    result['오행'] = calc_오행_분석(result)
    
    return result

# ============================================
# 대운 계산
# ============================================
def calc_대운(year, month, day, hour, minute, gender):
    """
    대운 계산
    gender: '남' 또는 '여'
    """
    사주 = calc_사주(year, month, day, hour, minute)
    
    년간 = 사주['년주'][0]
    월간 = 사주['월주'][0]
    월지 = 사주['월주'][1]
    일간 = 사주['일주'][0]
    
    년간_idx = 천간.index(년간)
    년간_음양 = 천간_음양[년간_idx]
    
    # 순행/역행 결정
    # 남자 + 양간 = 순행, 남자 + 음간 = 역행
    # 여자 + 양간 = 역행, 여자 + 음간 = 순행
    if gender == '남':
        순행 = (년간_음양 == '양')
    else:
        순행 = (년간_음양 == '음')
    
    # 대운수 계산 (간략화 - 실제로는 절기까지 일수로 계산)
    # 여기서는 생일 기준 대략적 계산
    절기_기준일 = {
        1: 6, 2: 4, 3: 6, 4: 5, 5: 6, 6: 6,
        7: 7, 8: 8, 9: 8, 10: 8, 11: 7, 12: 7
    }
    
    절기일 = 절기_기준일[month]
    
    if 순행:
        # 다음 절기까지 일수
        if day < 절기일:
            일수 = 절기일 - day
        else:
            # 다음 달 절기까지
            다음월 = (month % 12) + 1
            일수 = (30 - day) + 절기_기준일[다음월]
    else:
        # 이전 절기까지 일수
        if day >= 절기일:
            일수 = day - 절기일
        else:
            # 이전 달 절기까지
            이전월 = month - 1 if month > 1 else 12
            일수 = day + (30 - 절기_기준일[이전월])
    
    대운수 = round(일수 / 3)
    if 대운수 == 0:
        대운수 = 1
    
    # 대운 목록 생성 (10개)
    월간_idx = 천간.index(월간)
    월지_idx = 지지.index(월지)
    
    대운_list = []
    for i in range(10):
        if 순행:
            천간_idx = (월간_idx + i + 1) % 10
            지지_idx = (월지_idx + i + 1) % 12
        else:
            천간_idx = (월간_idx - i - 1) % 10
            지지_idx = (월지_idx - i - 1) % 12
        
        대운_천간 = 천간[천간_idx]
        대운_지지 = 지지[지지_idx]
        
        # 나이 계산
        시작_나이 = 대운수 + (i * 10)
        
        # 천간 십성
        천간_십성 = calc_십성(일간, 대운_천간, True)
        
        # 지지 십성 (지장간 본기 기준)
        지지_십성 = calc_십성(일간, 대운_지지, False)
        
        # 12운성
        운성 = calc_12운성(일간, 대운_지지)
        
        # 12신살
        년지 = 사주['년주'][1]
        신살 = calc_12신살(년지, 대운_지지)
        
        대운_list.append({
            '나이': 시작_나이,
            '천간': 대운_천간,
            '지지': 대운_지지,
            '천간_십성': 천간_십성,
            '지지_십성': 지지_십성,
            '12운성': 운성,
            '12신살': 신살,
        })
    
    return {
        '대운수': 대운수,
        '순행': 순행,
        '대운': 대운_list,
        '사주': 사주,
    }

# ============================================
# 세운 계산 (올해 기준 ±5년)
# ============================================
def calc_세운(year, month, day, hour, minute, 기준년=None):
    """
    세운 계산 (올해 기준 전후 10년)
    """
    from datetime import datetime
    
    if 기준년 is None:
        기준년 = datetime.now().year
    
    사주 = calc_사주(year, month, day, hour, minute)
    일간 = 사주['일주'][0]
    년지 = 사주['년주'][1]
    
    세운_list = []
    
    # 기준년 기준 -2년 ~ +7년 (10년)
    for i in range(-2, 8):
        target_year = 기준년 + i
        
        # 해당 년도의 년주 계산
        년주_천간, 년주_지지 = calc_년주(target_year, 6, 15)  # 6월 15일 기준
        
        # 천간 십성
        천간_십성 = calc_십성(일간, 년주_천간, True)
        
        # 지지 십성
        지지_십성 = calc_십성(일간, 년주_지지, False)
        
        # 12운성
        운성 = calc_12운성(일간, 년주_지지)
        
        # 12신살
        신살 = calc_12신살(년지, 년주_지지)
        
        # 나이 계산
        나이 = target_year - year + 1
        
        세운_list.append({
            '년도': target_year,
            '나이': 나이,
            '천간': 년주_천간,
            '지지': 년주_지지,
            '천간_십성': 천간_십성,
            '지지_십성': 지지_십성,
            '12운성': 운성,
            '12신살': 신살,
        })
    
    return {
        '세운': 세운_list,
        '사주': 사주,
    }

# ============================================
# 월운 계산 (올해 12개월)
# ============================================
def calc_월운(year, month, day, hour, minute, 기준년=None):
    """
    월운 계산 (기준년 12개월)
    """
    from datetime import datetime
    
    if 기준년 is None:
        기준년 = datetime.now().year
    
    사주 = calc_사주(year, month, day, hour, minute)
    일간 = 사주['일주'][0]
    년지 = 사주['년주'][1]
    
    # 기준년의 년간 계산
    기준년_천간, _ = calc_년주(기준년, 6, 15)
    
    월운_list = []
    
    for m in range(1, 13):
        # 해당 월의 월주 계산 (기준년의 년간 사용)
        월주_천간, 월주_지지 = calc_월주(기준년_천간, m, 15)
        
        # 천간 십성
        천간_십성 = calc_십성(일간, 월주_천간, True)
        
        # 지지 십성
        지지_십성 = calc_십성(일간, 월주_지지, False)
        
        # 12운성
        운성 = calc_12운성(일간, 월주_지지)
        
        # 12신살
        신살 = calc_12신살(년지, 월주_지지)
        
        월운_list.append({
            '월': m,
            '천간': 월주_천간,
            '지지': 월주_지지,
            '천간_십성': 천간_십성,
            '지지_십성': 지지_십성,
            '12운성': 운성,
            '12신살': 신살,
        })
    
    return {
        '년도': 기준년,
        '월운': 월운_list,
        '사주': 사주,
    }

# ============================================
# 신살 계산
# ============================================

# 도화살 (년지/일지 기준)
도화살_규칙 = {
    '인': '묘', '오': '묘', '술': '묘',  # 인오술 → 묘
    '사': '오', '유': '오', '축': '오',  # 사유축 → 오
    '신': '유', '자': '유', '진': '유',  # 신자진 → 유
    '해': '자', '묘': '자', '미': '자',  # 해묘미 → 자
}

# 역마살 (년지/일지 기준)
역마살_규칙 = {
    '인': '신', '오': '신', '술': '신',  # 인오술 → 신
    '사': '해', '유': '해', '축': '해',  # 사유축 → 해
    '신': '인', '자': '인', '진': '인',  # 신자진 → 인
    '해': '사', '묘': '사', '미': '사',  # 해묘미 → 사
}

# 화개살 (년지/일지 기준)
화개살_규칙 = {
    '인': '술', '오': '술', '술': '술',  # 인오술 → 술
    '사': '축', '유': '축', '축': '축',  # 사유축 → 축
    '신': '진', '자': '진', '진': '진',  # 신자진 → 진
    '해': '미', '묘': '미', '미': '미',  # 해묘미 → 미
}

# 양인살 (일간 기준) - 양간만 해당
양인살_규칙 = {
    '갑': '묘', '병': '오', '무': '오', '경': '유', '임': '자',
}

# 천을귀인 (일간 기준)
천을귀인_규칙 = {
    '갑': ['축', '미'], '무': ['축', '미'],
    '을': ['자', '신'], '기': ['자', '신'],
    '병': ['해', '유'], '정': ['해', '유'],
    '경': ['축', '미'], '신': ['인', '오'],
    '임': ['묘', '사'], '계': ['묘', '사'],
}

# 천덕귀인 (월지 기준)
천덕귀인_규칙 = {
    '인': '정', '묘': '신', '진': '임', '사': '신',
    '오': '갑', '미': '계', '신': '임', '유': '병',
    '술': '을', '해': '갑', '자': '계', '축': '경',
}

# 월덕귀인 (월지 기준)
월덕귀인_규칙 = {
    '인': '병', '오': '병', '술': '병',  # 인오술 → 병
    '사': '신', '유': '신', '축': '신',  # 사유축 → 신
    '신': '임', '자': '임', '진': '임',  # 신자진 → 임
    '해': '갑', '묘': '갑', '미': '갑',  # 해묘미 → 갑
}

# 문창귀인 (일간 기준)
문창귀인_규칙 = {
    '갑': '사', '을': '오', '병': '신', '정': '유',
    '무': '신', '기': '유', '경': '해', '신': '자',
    '임': '인', '계': '묘',
}

# 태극귀인 (일간 기준)
태극귀인_규칙 = {
    '갑': ['자', '오'], '기': ['자', '오'],
    '을': ['축', '미'], '경': ['축', '미'],
    '병': ['인', '신'], '신': ['인', '신'],
    '정': ['묘', '유'], '임': ['묘', '유'],
    '무': ['진', '술'], '계': ['진', '술'],
}

# 천의성 (일간 기준)
천의성_규칙 = {
    '갑': '축', '을': '자', '병': '해', '정': '술',
    '무': '유', '기': '신', '경': '미', '신': '오',
    '임': '사', '계': '진',
}

# 현침살 (일지 기준으로 천간/지지에서 찾음)
현침살_천간 = ['신', '임']  # 신금, 임수
현침살_지지 = ['유', '해']  # 유금, 해수

# 귀문관살 (일간 기준)
귀문관살_규칙 = {
    '갑': '미', '을': '오', '병': '사', '정': '진',
    '무': '사', '기': '진', '경': '묘', '신': '인',
    '임': '축', '계': '자',
}

# 백호살 (년지 기준)
백호살_규칙 = {
    '자': '오', '축': '미', '인': '신', '묘': '유',
    '진': '술', '사': '해', '오': '자', '미': '축',
    '신': '인', '유': '묘', '술': '진', '해': '사',
}

# 겁살 (년지/일지 기준)
겁살_규칙 = {
    '인': '사', '오': '사', '술': '사',  # 인오술 → 사
    '사': '인', '유': '인', '축': '인',  # 사유축 → 인
    '신': '해', '자': '해', '진': '해',  # 신자진 → 해
    '해': '신', '묘': '신', '미': '신',  # 해묘미 → 신
}

# 망신살 (년지/일지 기준)
망신살_규칙 = {
    '인': '신', '오': '자', '술': '진',
    '사': '해', '유': '묘', '축': '미',
    '신': '인', '자': '오', '진': '술',
    '해': '사', '묘': '유', '미': '축',
}

# 공망 (일주 기준) - 갑자순~계유순
공망_규칙 = {
    # 갑자순 (갑자~계유) → 술해 공망
    '갑자': ['술', '해'], '을축': ['술', '해'], '병인': ['술', '해'], 
    '정묘': ['술', '해'], '무진': ['술', '해'], '기사': ['술', '해'],
    '경오': ['술', '해'], '신미': ['술', '해'], '임신': ['술', '해'], '계유': ['술', '해'],
    # 갑술순 (갑술~계미) → 신유 공망
    '갑술': ['신', '유'], '을해': ['신', '유'], '병자': ['신', '유'],
    '정축': ['신', '유'], '무인': ['신', '유'], '기묘': ['신', '유'],
    '경진': ['신', '유'], '신사': ['신', '유'], '임오': ['신', '유'], '계미': ['신', '유'],
    # 갑신순 (갑신~계사) → 오미 공망
    '갑신': ['오', '미'], '을유': ['오', '미'], '병술': ['오', '미'],
    '정해': ['오', '미'], '무자': ['오', '미'], '기축': ['오', '미'],
    '경인': ['오', '미'], '신묘': ['오', '미'], '임진': ['오', '미'], '계사': ['오', '미'],
    # 갑오순 (갑오~계묘) → 진사 공망
    '갑오': ['진', '사'], '을미': ['진', '사'], '병신': ['진', '사'],
    '정유': ['진', '사'], '무술': ['진', '사'], '기해': ['진', '사'],
    '경자': ['진', '사'], '신축': ['진', '사'], '임인': ['진', '사'], '계묘': ['진', '사'],
    # 갑진순 (갑진~계축) → 인묘 공망
    '갑진': ['인', '묘'], '을사': ['인', '묘'], '병오': ['인', '묘'],
    '정미': ['인', '묘'], '무신': ['인', '묘'], '기유': ['인', '묘'],
    '경술': ['인', '묘'], '신해': ['인', '묘'], '임자': ['인', '묘'], '계축': ['인', '묘'],
    # 갑인순 (갑인~계해) → 자축 공망
    '갑인': ['자', '축'], '을묘': ['자', '축'], '병진': ['자', '축'],
    '정사': ['자', '축'], '무오': ['자', '축'], '기미': ['자', '축'],
    '경신': ['자', '축'], '신유': ['자', '축'], '임술': ['자', '축'], '계해': ['자', '축'],
}

# 홍염살 (일간 기준)
홍염살_규칙 = {
    '갑': '오', '을': '신', '병': '인', '정': '미',
    '무': '진', '기': '진', '경': '술', '신': '유',
    '임': '자', '계': '신',
}

# 과숙살 (고란살) - 일지 기준
과숙살_일지 = ['인', '진', '사', '미', '술', '해']  # 양남/음녀
고란살_일지 = ['자', '축', '묘', '오', '신', '유']  # 음남/양녀

# 고신살 (년지 기준)
고신살_규칙 = {
    '자': '인', '축': '인', '인': '사', '묘': '사',
    '진': '사', '사': '신', '오': '신', '미': '신',
    '신': '해', '유': '해', '술': '해', '해': '인',
}

# 과강살 (일주 특정 조합)
과강살_일주 = ['무진', '무술', '경진', '경술', '임진', '임술']

# 장성살 (년지 기준)
장성살_규칙 = {
    '인': '사', '오': '사', '술': '사',
    '사': '신', '유': '신', '축': '신',
    '신': '해', '자': '해', '진': '해',
    '해': '인', '묘': '인', '미': '인',
}

# 반안살 (년지 기준)
반안살_규칙 = {
    '인': '술', '오': '인', '술': '오',
    '사': '축', '유': '사', '축': '유',
    '신': '진', '자': '신', '진': '자',
    '해': '미', '묘': '해', '미': '묘',
}


def calc_신살(사주_data, gender='남'):
    """
    신살 계산
    사주_data: calc_사주() 결과
    gender: '남' 또는 '여'
    
    Returns: {
        '천간신살': {'년': [...], '월': [...], '일': [...], '시': [...]},
        '지지신살': {'년': [...], '월': [...], '일': [...], '시': [...]},
        '길신': [...],
        '흉신': [...],
        '특수신살': [...],
    }
    """
    
    일간 = 사주_data['일주'][0]
    일지 = 사주_data['일주'][1]
    년지 = 사주_data['년주'][1]
    월지 = 사주_data['월주'][1]
    시지 = 사주_data['시주'][1]
    
    년간 = 사주_data['년주'][0]
    월간 = 사주_data['월주'][0]
    시간 = 사주_data['시주'][0]
    
    일주 = 일간 + 일지
    
    # 결과 초기화
    천간신살 = {'년': [], '월': [], '일': [], '시': []}
    지지신살 = {'년': [], '월': [], '일': [], '시': []}
    길신 = []
    흉신 = []
    특수신살 = []
    
    지지들 = {'년': 년지, '월': 월지, '일': 일지, '시': 시지}
    천간들 = {'년': 년간, '월': 월간, '일': 일간, '시': 시간}
    
    # ========== 도화살 (년지, 일지 기준) ==========
    for 기준 in [년지, 일지]:
        if 기준 in 도화살_규칙:
            도화_지지 = 도화살_규칙[기준]
            for col, 지지 in 지지들.items():
                if 지지 == 도화_지지 and '도화살' not in 지지신살[col]:
                    지지신살[col].append('도화살')
                    if ('도화살', col) not in [(x[0], x[1]) for x in 흉신]:
                        흉신.append(('도화살', col))
    
    # ========== 역마살 (년지, 일지 기준) ==========
    for 기준 in [년지, 일지]:
        if 기준 in 역마살_규칙:
            역마_지지 = 역마살_규칙[기준]
            for col, 지지 in 지지들.items():
                if 지지 == 역마_지지 and '역마살' not in 지지신살[col]:
                    지지신살[col].append('역마살')
                    if ('역마살', col) not in [(x[0], x[1]) for x in 흉신]:
                        흉신.append(('역마살', col))
    
    # ========== 화개살 (년지, 일지 기준) ==========
    for 기준 in [년지, 일지]:
        if 기준 in 화개살_규칙:
            화개_지지 = 화개살_규칙[기준]
            for col, 지지 in 지지들.items():
                if 지지 == 화개_지지 and '화개살' not in 지지신살[col]:
                    지지신살[col].append('화개살')
                    if ('화개살', col) not in [(x[0], x[1]) for x in 특수신살]:
                        특수신살.append(('화개살', col))
    
    # ========== 양인살 (일간 기준) ==========
    if 일간 in 양인살_규칙:
        양인_지지 = 양인살_규칙[일간]
        for col, 지지 in 지지들.items():
            if 지지 == 양인_지지 and '양인살' not in 지지신살[col]:
                지지신살[col].append('양인살')
                if ('양인살', col) not in [(x[0], x[1]) for x in 흉신]:
                    흉신.append(('양인살', col))
    
    # ========== 천을귀인 (일간 기준) ==========
    if 일간 in 천을귀인_규칙:
        귀인_지지들 = 천을귀인_규칙[일간]
        for col, 지지 in 지지들.items():
            if 지지 in 귀인_지지들 and '천을귀인' not in 지지신살[col]:
                지지신살[col].append('천을귀인')
                if ('천을귀인', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('천을귀인', col))
    
    # ========== 천덕귀인 (월지 기준) ==========
    if 월지 in 천덕귀인_규칙:
        천덕_천간 = 천덕귀인_규칙[월지]
        for col, 천간 in 천간들.items():
            if 천간 == 천덕_천간 and '천덕귀인' not in 천간신살[col]:
                천간신살[col].append('천덕귀인')
                if ('천덕귀인', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('천덕귀인', col))
    
    # ========== 월덕귀인 (월지 기준) ==========
    if 월지 in 월덕귀인_규칙:
        월덕_천간 = 월덕귀인_규칙[월지]
        for col, 천간 in 천간들.items():
            if 천간 == 월덕_천간 and '월덕귀인' not in 천간신살[col]:
                천간신살[col].append('월덕귀인')
                if ('월덕귀인', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('월덕귀인', col))
    
    # ========== 문창귀인 (일간 기준) ==========
    if 일간 in 문창귀인_규칙:
        문창_지지 = 문창귀인_규칙[일간]
        for col, 지지 in 지지들.items():
            if 지지 == 문창_지지 and '문창귀인' not in 지지신살[col]:
                지지신살[col].append('문창귀인')
                if ('문창귀인', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('문창귀인', col))
    
    # ========== 태극귀인 (일간 기준) ==========
    if 일간 in 태극귀인_규칙:
        태극_지지들 = 태극귀인_규칙[일간]
        for col, 지지 in 지지들.items():
            if 지지 in 태극_지지들 and '태극귀인' not in 지지신살[col]:
                지지신살[col].append('태극귀인')
                if ('태극귀인', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('태극귀인', col))
    
    # ========== 천의성 (일간 기준) ==========
    if 일간 in 천의성_규칙:
        천의_지지 = 천의성_규칙[일간]
        for col, 지지 in 지지들.items():
            if 지지 == 천의_지지 and '천의성' not in 지지신살[col]:
                지지신살[col].append('천의성')
                if ('천의성', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('천의성', col))
    
    # ========== 현침살 (특정 천간/지지) ==========
    for col, 천간 in 천간들.items():
        if 천간 in 현침살_천간 and '현침살' not in 천간신살[col]:
            천간신살[col].append('현침살')
            if ('현침살', col + '간') not in [(x[0], x[1]) for x in 특수신살]:
                특수신살.append(('현침살', col + '간'))
    
    for col, 지지 in 지지들.items():
        if 지지 in 현침살_지지 and '현침살' not in 지지신살[col]:
            지지신살[col].append('현침살')
            if ('현침살', col + '지') not in [(x[0], x[1]) for x in 특수신살]:
                특수신살.append(('현침살', col + '지'))
    
    # ========== 귀문관살 (일간 기준) ==========
    if 일간 in 귀문관살_규칙:
        귀문_지지 = 귀문관살_규칙[일간]
        for col, 지지 in 지지들.items():
            if 지지 == 귀문_지지 and '귀문관살' not in 지지신살[col]:
                지지신살[col].append('귀문관살')
                if ('귀문관살', col) not in [(x[0], x[1]) for x in 흉신]:
                    흉신.append(('귀문관살', col))
    
    # ========== 백호살 (년지 기준) ==========
    if 년지 in 백호살_규칙:
        백호_지지 = 백호살_규칙[년지]
        for col, 지지 in 지지들.items():
            if 지지 == 백호_지지 and '백호살' not in 지지신살[col]:
                지지신살[col].append('백호살')
                if ('백호살', col) not in [(x[0], x[1]) for x in 흉신]:
                    흉신.append(('백호살', col))
    
    # ========== 겁살 (년지, 일지 기준) ==========
    for 기준 in [년지, 일지]:
        if 기준 in 겁살_규칙:
            겁살_지지 = 겁살_규칙[기준]
            for col, 지지 in 지지들.items():
                if 지지 == 겁살_지지 and '겁살' not in 지지신살[col]:
                    지지신살[col].append('겁살')
                    if ('겁살', col) not in [(x[0], x[1]) for x in 흉신]:
                        흉신.append(('겁살', col))
    
    # ========== 망신살 (년지 기준) ==========
    if 년지 in 망신살_규칙:
        망신_지지 = 망신살_규칙[년지]
        for col, 지지 in 지지들.items():
            if 지지 == 망신_지지 and '망신살' not in 지지신살[col]:
                지지신살[col].append('망신살')
                if ('망신살', col) not in [(x[0], x[1]) for x in 흉신]:
                    흉신.append(('망신살', col))
    
    # ========== 공망 (일주 기준) ==========
    if 일주 in 공망_규칙:
        공망_지지들 = 공망_규칙[일주]
        for col, 지지 in 지지들.items():
            if 지지 in 공망_지지들 and '공망' not in 지지신살[col]:
                지지신살[col].append('공망')
                if ('공망', col) not in [(x[0], x[1]) for x in 특수신살]:
                    특수신살.append(('공망', col))
    
    # ========== 홍염살 (일간 기준) ==========
    if 일간 in 홍염살_규칙:
        홍염_지지 = 홍염살_규칙[일간]
        for col, 지지 in 지지들.items():
            if 지지 == 홍염_지지 and '홍염살' not in 지지신살[col]:
                지지신살[col].append('홍염살')
                if ('홍염살', col) not in [(x[0], x[1]) for x in 특수신살]:
                    특수신살.append(('홍염살', col))
    
    # ========== 과강살 (일주 특정 조합) ==========
    if 일주 in 과강살_일주:
        if '과강살' not in 지지신살['일']:
            지지신살['일'].append('과강살')
            특수신살.append(('과강살', '일'))
    
    # ========== 장성살 (년지 기준) ==========
    if 년지 in 장성살_규칙:
        장성_지지 = 장성살_규칙[년지]
        for col, 지지 in 지지들.items():
            if 지지 == 장성_지지 and '장성살' not in 지지신살[col]:
                지지신살[col].append('장성살')
                if ('장성살', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('장성살', col))
    
    # ========== 반안살 (년지 기준) ==========
    if 년지 in 반안살_규칙:
        반안_지지 = 반안살_규칙[년지]
        for col, 지지 in 지지들.items():
            if 지지 == 반안_지지 and '반안살' not in 지지신살[col]:
                지지신살[col].append('반안살')
                if ('반안살', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('반안살', col))
    
    return {
        '천간신살': 천간신살,
        '지지신살': 지지신살,
        '길신': 길신,
        '흉신': 흉신,
        '특수신살': 특수신살,
    }

# ============================================
# 테스트 - 샘플 검증
# ============================================
if __name__ == "__main__":
    print("=" * 70)
    print("샘플 2: 구대회 (1981-03-13 03:30)")
    print("=" * 70)
    result = calc_사주(1981, 3, 13, 3, 30)
    
    print(f"\n{'':10} {'시주':10} {'일주':10} {'월주':10} {'년주':10}")
    print("-" * 50)
    print(f"{'천간':10} {result['시주'][0]:10} {result['일주'][0]:10} {result['월주'][0]:10} {result['년주'][0]:10}")
    print(f"{'지지':10} {result['시주'][1]:10} {result['일주'][1]:10} {result['월주'][1]:10} {result['년주'][1]:10}")
    print(f"{'천간십성':10} {result['천간십성']['시']:10} {result['천간십성']['일']:10} {result['천간십성']['월']:10} {result['천간십성']['년']:10}")
    print(f"{'지지십성':10} {result['지지십성']['시']:10} {result['지지십성']['일']:10} {result['지지십성']['월']:10} {result['지지십성']['년']:10}")
    print(f"{'지장간':10} {result['지장간']['시']:10} {result['지장간']['일']:10} {result['지장간']['월']:10} {result['지장간']['년']:10}")
    print(f"{'12운성':10} {result['12운성']['시']:10} {result['12운성']['일']:10} {result['12운성']['월']:10} {result['12운성']['년']:10}")
    print(f"{'12신살':10} {result['12신살']['시']:10} {result['12신살']['일']:10} {result['12신살']['월']:10} {result['12신살']['년']:10}")
    
    print(f"\n오행 분포: {result['오행']}")
    
    print("\n" + "=" * 70)
    print("정답 비교 (이미지 기준)")
    print("=" * 70)
    print("천간: 무(戊) 경(庚) 신(辛) 신(辛)")
    print("지지: 인(寅) 인(寅) 묘(卯) 유(酉)")
    print("천간십성: 편인 일간(나) 겁재 겁재")
    print("지지십성: 편재 편재 정재 겁재")
    print("지장간: 무병갑 무병갑 갑을 경신")
    print("12운성: 절 절 태 제왕")
    print("12신살: 겁살 겁살 재살 장성살")
