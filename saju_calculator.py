# 만세력 계산기 v1
# 샘플 데이터로 로직 검증
from functools import lru_cache

# ============================================
# 기본 데이터 테이블
# ============================================

# 천간 (10개)
천간 = ['갑', '을', '병', '정', '무', '기', '경', '신', '임', '계']
천간_한자 = ['甲', '乙', '丙', '丁', '戊', '己', '庚', '辛', '壬', '癸']
천간_오행 = ['목', '목', '화', '화', '토', '토', '금', '금', '수', '수']
천간_음양 = ['양', '음', '양', '음', '양', '음', '양', '음', '양', '음']

# 지지 (12개)
지지 = ['자', '축', '인', '묘', '진', '사', '오', '미', '신', '유', '술', '해']
지지_한자 = ['子', '丑', '寅', '卯', '辰', '巳', '午', '未', '申', '酉', '戌', '亥']
지지_오행 = ['수', '토', '목', '목', '토', '화', '화', '토', '금', '금', '토', '수']
지지_음양 = ['양', '음', '양', '음', '양', '음', '양', '음', '양', '음', '양', '음']

# 빠른 조회를 위한 인덱스 맵 (O(1) 조회)
천간_index = {c: i for i, c in enumerate(천간)}
지지_index = {j: i for i, j in enumerate(지지)}

@lru_cache(maxsize=128)
def get_60갑자(index):
    """60갑자 인덱스로 천간/지지 반환 (캐싱)"""
    천간_idx = index % 10
    지지_idx = index % 12
    return 천간[천간_idx], 지지[지지_idx]

# ============================================
# 년주 계산
# ============================================
def calc_년주(year, month, day):
    """
    년주 계산 - 입춘 기준
    입춘 전이면 전년도로 계산
    입춘: 대략 2월 4일 (정확한 계산은 별도 필요)
    """
    # 입춘 전이면 전년도
    if month == 1 or (month == 2 and day < 4):
        year = year - 1
    
    # 1984년 = 갑자년 (index 0)
    index = (year - 1984) % 60
    if index < 0:
        index += 60
    
    천간_idx = index % 10
    지지_idx = index % 12
    
    return 천간[천간_idx], 지지[지지_idx]

# ============================================
# 월주 계산 - 오호둔갑법
# ============================================
월주_천간_시작 = {
    '갑': 2, '기': 2,  # 갑기년 -> 병인월 시작 (병=2)
    '을': 4, '경': 4,  # 을경년 -> 무인월 시작 (무=4)
    '병': 6, '신': 6,  # 병신년 -> 경인월 시작 (경=6)
    '정': 8, '임': 8,  # 정임년 -> 임인월 시작 (임=8)
    '무': 0, '계': 0,  # 무계년 -> 갑인월 시작 (갑=0)
}

# 절기 기준 월 (대략적인 양력 날짜)
절기_시작 = {
    1: (2, 4),   # 인월: 입춘 ~2/4
    2: (3, 6),   # 묘월: 경칩 ~3/6
    3: (4, 5),   # 진월: 청명 ~4/5
    4: (5, 6),   # 사월: 입하 ~5/6
    5: (6, 6),   # 오월: 망종 ~6/6
    6: (7, 7),   # 미월: 소서 ~7/7
    7: (8, 8),   # 신월: 입추 ~8/8
    8: (9, 8),   # 유월: 백로 ~9/8
    9: (10, 8),  # 술월: 한로 ~10/8
    10: (11, 7), # 해월: 입동 ~11/7
    11: (12, 7), # 자월: 대설 ~12/7
    12: (1, 6),  # 축월: 소한 ~1/6
}

def get_월_from_양력(month, day):
    """양력 월일로 절기 기준 월 계산 (인월=1, 묘월=2, ...)"""
    for 월, (시작월, 시작일) in 절기_시작.items():
        다음월 = (월 % 12) + 1
        다음_시작월, 다음_시작일 = 절기_시작[다음월]
        
        if 시작월 == month:
            if day >= 시작일:
                return 월
        
    # 간단한 매핑 (대략적)
    if month == 2 and day >= 4:
        return 1  # 인월
    elif month == 3 and day >= 6:
        return 2  # 묘월
    elif month == 4 and day >= 5:
        return 3  # 진월
    elif month == 5 and day >= 6:
        return 4  # 사월
    elif month == 6 and day >= 6:
        return 5  # 오월
    elif month == 7 and day >= 7:
        return 6  # 미월
    elif month == 8 and day >= 8:
        return 7  # 신월
    elif month == 9 and day >= 8:
        return 8  # 유월
    elif month == 10 and day >= 8:
        return 9  # 술월
    elif month == 11 and day >= 7:
        return 10 # 해월
    elif month == 12 and day >= 7:
        return 11 # 자월
    elif month == 1 and day >= 6:
        return 12 # 축월
    else:
        # 이전 월
        if month == 1:
            return 11  # 자월
        elif month == 2:
            return 12  # 축월
        elif month == 3:
            return 1   # 인월
        elif month == 4:
            return 2   # 묘월
        elif month == 5:
            return 3   # 진월
        elif month == 6:
            return 4   # 사월
        elif month == 7:
            return 5   # 오월
        elif month == 8:
            return 6   # 미월
        elif month == 9:
            return 7   # 신월
        elif month == 10:
            return 8   # 유월
        elif month == 11:
            return 9   # 술월
        elif month == 12:
            return 10  # 해월

def calc_월주(년간, month, day):
    """월주 계산"""
    월_index = get_월_from_양력(month, day)  # 1=인월, 2=묘월, ...
    
    # 월지 계산 (인월=인(2), 묘월=묘(3), ...)
    지지_idx = (월_index + 1) % 12  # 인=2
    
    # 월간 계산 (오호둔갑)
    시작_천간 = 월주_천간_시작[년간]
    천간_idx = (시작_천간 + 월_index - 1) % 10
    
    return 천간[천간_idx], 지지[지지_idx]

# ============================================
# 일주 계산
# ============================================
from datetime import date

def calc_일주(year, month, day):
    """
    일주 계산 - 기준일로부터 날짜 차이
    기준일: 1900년 1월 1일 = 갑진일 (index 40)
    """
    기준일 = date(1900, 1, 1)
    기준일_갑자_index = 10  # 갑술 (역산으로 확인)
    
    대상일 = date(year, month, day)
    차이 = (대상일 - 기준일).days
    
    index = (기준일_갑자_index + 차이) % 60
    
    천간_idx = index % 10
    지지_idx = index % 12
    
    return 천간[천간_idx], 지지[지지_idx]

# ============================================
# 시주 계산 - 오서둔갑법
# ============================================
시주_천간_시작 = {
    '갑': 0, '기': 0,  # 갑기일 -> 갑자시 시작
    '을': 2, '경': 2,  # 을경일 -> 병자시 시작
    '병': 4, '신': 4,  # 병신일 -> 무자시 시작
    '정': 6, '임': 6,  # 정임일 -> 경자시 시작
    '무': 8, '계': 8,  # 무계일 -> 임자시 시작
}

def get_시지_index(hour, minute=0):
    """시간으로 시지 인덱스 계산"""
    # 자시: 23:00~00:59, 축시: 01:00~02:59, ...
    total_minutes = hour * 60 + minute
    
    if total_minutes >= 23 * 60 or total_minutes < 1 * 60:
        return 0  # 자
    elif total_minutes < 3 * 60:
        return 1  # 축
    elif total_minutes < 5 * 60:
        return 2  # 인
    elif total_minutes < 7 * 60:
        return 3  # 묘
    elif total_minutes < 9 * 60:
        return 4  # 진
    elif total_minutes < 11 * 60:
        return 5  # 사
    elif total_minutes < 13 * 60:
        return 6  # 오
    elif total_minutes < 15 * 60:
        return 7  # 미
    elif total_minutes < 17 * 60:
        return 8  # 신
    elif total_minutes < 19 * 60:
        return 9  # 유
    elif total_minutes < 21 * 60:
        return 10 # 술
    else:
        return 11 # 해

def calc_시주(일간, hour, minute=0):
    """시주 계산"""
    지지_idx = get_시지_index(hour, minute)
    
    # 시간 천간 계산 (오서둔갑)
    시작_천간 = 시주_천간_시작[일간]
    천간_idx = (시작_천간 + 지지_idx) % 10
    
    return 천간[천간_idx], 지지[지지_idx]

# ============================================
# 십성 계산
# ============================================
오행_관계 = {
    # 일간오행: {대상오행: (같은음양, 다른음양)}
    '목': {'목': ('비견', '겁재'), '화': ('식신', '상관'), '토': ('편재', '정재'), '금': ('편관', '정관'), '수': ('편인', '정인')},
    '화': {'화': ('비견', '겁재'), '토': ('식신', '상관'), '금': ('편재', '정재'), '수': ('편관', '정관'), '목': ('편인', '정인')},
    '토': {'토': ('비견', '겁재'), '금': ('식신', '상관'), '수': ('편재', '정재'), '목': ('편관', '정관'), '화': ('편인', '정인')},
    '금': {'금': ('비견', '겁재'), '수': ('식신', '상관'), '목': ('편재', '정재'), '화': ('편관', '정관'), '토': ('편인', '정인')},
    '수': {'수': ('비견', '겁재'), '목': ('식신', '상관'), '화': ('편재', '정재'), '토': ('편관', '정관'), '금': ('편인', '정인')},
}

def calc_십성(일간, 대상, is_천간=True):
    """십성 계산"""
    일간_idx = 천간.index(일간)
    일간_오행 = 천간_오행[일간_idx]
    일간_음양 = 천간_음양[일간_idx]
    
    if is_천간:
        대상_idx = 천간.index(대상)
        대상_오행 = 천간_오행[대상_idx]
        대상_음양 = 천간_음양[대상_idx]
    else:
        # 지지는 지장간 본기 기준으로 계산
        본기 = 지장간_본기[대상]
        본기_idx = 천간.index(본기)
        대상_오행 = 천간_오행[본기_idx]
        대상_음양 = 천간_음양[본기_idx]
    
    관계 = 오행_관계[일간_오행][대상_오행]
    
    # 같은 음양이면 [0], 다른 음양이면 [1]
    if 일간_음양 == 대상_음양:
        return 관계[0]
    else:
        return 관계[1]

# ============================================
# 12운성 계산
# ============================================
# 일간별 12운성 시작 지지 (장생 위치)
운성_12 = ['장생', '목욕', '관대', '건록', '제왕', '쇠', '병', '사', '묘', '절', '태', '양']

# 양간: 순행, 음간: 역행
장생_위치 = {
    '갑': 11,  # 해
    '을': 6,   # 오
    '병': 2,   # 인
    '정': 9,   # 유
    '무': 2,   # 인
    '기': 9,   # 유
    '경': 5,   # 사
    '신': 0,   # 자
    '임': 8,   # 신
    '계': 3,   # 묘
}

def calc_12운성(일간, 지지_char):
    """12운성 계산"""
    일간_idx = 천간.index(일간)
    음양 = 천간_음양[일간_idx]
    지지_idx = 지지.index(지지_char)
    
    장생_지지 = 장생_위치[일간]
    
    if 음양 == '양':
        # 순행
        운성_idx = (지지_idx - 장생_지지) % 12
    else:
        # 역행
        운성_idx = (장생_지지 - 지지_idx) % 12
    
    return 운성_12[운성_idx]

# ============================================
# 지장간
# ============================================
지장간_표 = {
    '자': '계',        # 단일
    '축': '기신계',
    '인': '갑병무',
    '묘': '을',        # 단일
    '진': '무을계',
    '사': '병무경',
    '오': '정기',
    '미': '기정을',
    '신': '경임무',
    '유': '신',        # 단일
    '술': '무신정',
    '해': '임갑',
}

# 지장간 본기 (가장 강한 기운 = 정기)
지장간_본기 = {
    '자': '계',  # 수
    '축': '기',  # 토
    '인': '갑',  # 목
    '묘': '을',  # 목
    '진': '무',  # 토
    '사': '병',  # 화
    '오': '정',  # 화  
    '미': '기',  # 토
    '신': '경',  # 금
    '유': '신',  # 금
    '술': '무',  # 토
    '해': '임',  # 수
}

def get_지장간(지지_char):
    """지장간 반환"""
    return 지장간_표.get(지지_char, '')

# ============================================
# 12신살 계산 (삼합 기준)
# ============================================
# 년지로 삼합 판단
년지_삼합 = {
    '인': '인오술', '오': '인오술', '술': '인오술',
    '사': '사유축', '유': '사유축', '축': '사유축',
    '신': '신자진', '자': '신자진', '진': '신자진',
    '해': '해묘미', '묘': '해묘미', '미': '해묘미',
}

# 삼합별 겁살 위치 (지지 인덱스)
겁살_위치 = {
    '인오술': 5,  # 사
    '사유축': 2,  # 인
    '신자진': 11, # 해
    '해묘미': 8,  # 신
}

# 12신살 순서 (겁살부터 시계방향)
신살_순서 = ['겁살', '재살', '천살', '지살', '연살', '월살', '망신', '장성', '반안', '역마', '육해', '화개']

def calc_12신살(년지, 대상_지지):
    """삼합 기준 12신살 계산"""
    삼합 = 년지_삼합[년지]
    겁살_지지_idx = 겁살_위치[삼합]
    대상_idx = 지지.index(대상_지지)
    
    # 겁살 위치에서 대상까지의 거리
    거리 = (대상_idx - 겁살_지지_idx) % 12
    
    return 신살_순서[거리]

# ============================================
# 오행 분석
# ============================================
def calc_오행_분석(사주_결과):
    """오행 개수 분석"""
    오행_count = {'목': 0, '화': 0, '토': 0, '금': 0, '수': 0}
    
    for 주 in ['년주', '월주', '일주', '시주']:
        간, 지 = 사주_결과[주]
        간_idx = 천간.index(간)
        지_idx = 지지.index(지)
        오행_count[천간_오행[간_idx]] += 1
        오행_count[지지_오행[지_idx]] += 1
    
    return 오행_count

# ============================================
# 전체 사주 계산
# ============================================
def calc_사주(year, month, day, hour, minute=0):
    """전체 사주 계산"""
    년간, 년지 = calc_년주(year, month, day)
    월간, 월지 = calc_월주(년간, month, day)
    일간, 일지 = calc_일주(year, month, day)
    시간, 시지 = calc_시주(일간, hour, minute)
    
    result = {
        '년주': (년간, 년지),
        '월주': (월간, 월지),
        '일주': (일간, 일지),
        '시주': (시간, 시지),
        '천간십성': {
            '년': calc_십성(일간, 년간, True),
            '월': calc_십성(일간, 월간, True),
            '일': '일간(나)',
            '시': calc_십성(일간, 시간, True),
        },
        '지지십성': {
            '년': calc_십성(일간, 년지, False),
            '월': calc_십성(일간, 월지, False),
            '일': calc_십성(일간, 일지, False),
            '시': calc_십성(일간, 시지, False),
        },
        '12운성': {
            '년': calc_12운성(일간, 년지),
            '월': calc_12운성(일간, 월지),
            '일': calc_12운성(일간, 일지),
            '시': calc_12운성(일간, 시지),
        },
        '지장간': {
            '년': get_지장간(년지),
            '월': get_지장간(월지),
            '일': get_지장간(일지),
            '시': get_지장간(시지),
        },
        '12신살': {
            '년': calc_12신살(년지, 년지),
            '월': calc_12신살(년지, 월지),
            '일': calc_12신살(년지, 일지),
            '시': calc_12신살(년지, 시지),
        },
        '오행': None,  # 나중에 계산
    }
    
    result['오행'] = calc_오행_분석(result)
    
    return result

# ============================================
# 대운 계산
# ============================================
def calc_대운(year, month, day, hour, minute, gender):
    """
    대운 계산
    gender: '남' 또는 '여'
    """
    사주 = calc_사주(year, month, day, hour, minute)
    
    년간 = 사주['년주'][0]
    월간 = 사주['월주'][0]
    월지 = 사주['월주'][1]
    일간 = 사주['일주'][0]
    
    년간_idx = 천간.index(년간)
    년간_음양 = 천간_음양[년간_idx]
    
    # 순행/역행 결정
    # 남자 + 양간 = 순행, 남자 + 음간 = 역행
    # 여자 + 양간 = 역행, 여자 + 음간 = 순행
    if gender == '남':
        순행 = (년간_음양 == '양')
    else:
        순행 = (년간_음양 == '음')
    
    # 대운수 계산 (간략화 - 실제로는 절기까지 일수로 계산)
    # 여기서는 생일 기준 대략적 계산
    절기_기준일 = {
        1: 6, 2: 4, 3: 6, 4: 5, 5: 6, 6: 6,
        7: 7, 8: 8, 9: 8, 10: 8, 11: 7, 12: 7
    }
    
    절기일 = 절기_기준일[month]
    
    if 순행:
        # 다음 절기까지 일수
        if day < 절기일:
            일수 = 절기일 - day
        else:
            # 다음 달 절기까지
            다음월 = (month % 12) + 1
            일수 = (30 - day) + 절기_기준일[다음월]
    else:
        # 이전 절기까지 일수
        if day >= 절기일:
            일수 = day - 절기일
        else:
            # 이전 달 절기까지
            이전월 = month - 1 if month > 1 else 12
            일수 = day + (30 - 절기_기준일[이전월])
    
    대운수 = round(일수 / 3)
    if 대운수 == 0:
        대운수 = 1
    
    # 대운 목록 생성 (12개 - 100세 이상 커버)
    월간_idx = 천간.index(월간)
    월지_idx = 지지.index(월지)
    
    대운_list = []
    for i in range(12):
        if 순행:
            천간_idx = (월간_idx + i + 1) % 10
            지지_idx = (월지_idx + i + 1) % 12
        else:
            천간_idx = (월간_idx - i - 1) % 10
            지지_idx = (월지_idx - i - 1) % 12
        
        대운_천간 = 천간[천간_idx]
        대운_지지 = 지지[지지_idx]
        
        # 나이 계산
        시작_나이 = 대운수 + (i * 10)
        
        # 천간 십성
        천간_십성 = calc_십성(일간, 대운_천간, True)
        
        # 지지 십성 (지장간 본기 기준)
        지지_십성 = calc_십성(일간, 대운_지지, False)
        
        # 12운성
        운성 = calc_12운성(일간, 대운_지지)
        
        # 12신살
        년지 = 사주['년주'][1]
        신살 = calc_12신살(년지, 대운_지지)
        
        대운_list.append({
            '나이': 시작_나이,
            '천간': 대운_천간,
            '지지': 대운_지지,
            '천간_십성': 천간_십성,
            '지지_십성': 지지_십성,
            '12운성': 운성,
            '12신살': 신살,
        })
    
    return {
        '대운수': 대운수,
        '순행': 순행,
        '대운': 대운_list,
        '사주': 사주,
    }

# ============================================
# 세운 계산 (올해 기준 ±5년)
# ============================================
def calc_세운(year, month, day, hour, minute, 기준년=None):
    """
    세운 계산 (당해년부터 10년)
    """
    from datetime import datetime
    
    if 기준년 is None:
        기준년 = datetime.now().year
    
    사주 = calc_사주(year, month, day, hour, minute)
    일간 = 사주['일주'][0]
    년지 = 사주['년주'][1]
    
    세운_list = []
    
    # 당해년부터 10년
    for i in range(10):
        target_year = 기준년 + i
        
        # 해당 년도의 년주 계산
        년주_천간, 년주_지지 = calc_년주(target_year, 6, 15)  # 6월 15일 기준
        
        # 천간 십성
        천간_십성 = calc_십성(일간, 년주_천간, True)
        
        # 지지 십성
        지지_십성 = calc_십성(일간, 년주_지지, False)
        
        # 12운성
        운성 = calc_12운성(일간, 년주_지지)
        
        # 12신살
        신살 = calc_12신살(년지, 년주_지지)
        
        # 나이 계산
        나이 = target_year - year + 1
        
        세운_list.append({
            '년도': target_year,
            '나이': 나이,
            '천간': 년주_천간,
            '지지': 년주_지지,
            '천간_십성': 천간_십성,
            '지지_십성': 지지_십성,
            '12운성': 운성,
            '12신살': 신살,
        })
    
    return {
        '세운': 세운_list,
        '사주': 사주,
    }

# ============================================
# 월운 계산 (당해월부터 12개월)
# ============================================
def calc_월운(year, month, day, hour, minute, 기준년=None, 기준월=None):
    """
    월운 계산 (당해월부터 18개월)
    """
    from datetime import datetime
    
    now = datetime.now()
    if 기준년 is None:
        기준년 = now.year
    if 기준월 is None:
        기준월 = now.month
    
    사주 = calc_사주(year, month, day, hour, minute)
    일간 = 사주['일주'][0]
    년지 = 사주['년주'][1]
    
    월운_list = []
    
    현재_년 = 기준년
    현재_월 = 기준월
    
    for i in range(18):  # 18개월
        # 해당 년의 년간 계산
        년_천간, _ = calc_년주(현재_년, 6, 15)
        
        # 해당 월의 월주 계산
        월주_천간, 월주_지지 = calc_월주(년_천간, 현재_월, 15)
        
        # 천간 십성
        천간_십성 = calc_십성(일간, 월주_천간, True)
        
        # 지지 십성
        지지_십성 = calc_십성(일간, 월주_지지, False)
        
        # 12운성
        운성 = calc_12운성(일간, 월주_지지)
        
        # 12신살
        신살 = calc_12신살(년지, 월주_지지)
        
        월운_list.append({
            '년도': 현재_년,
            '월': 현재_월,
            '천간': 월주_천간,
            '지지': 월주_지지,
            '천간_십성': 천간_십성,
            '지지_십성': 지지_십성,
            '12운성': 운성,
            '12신살': 신살,
        })
        
        # 다음 달로
        현재_월 += 1
        if 현재_월 > 12:
            현재_월 = 1
            현재_년 += 1
    
    return {
        '시작년': 기준년,
        '시작월': 기준월,
        '월운': 월운_list,
        '사주': 사주,
    }

# ============================================
# 신살 계산
# ============================================

# 도화살 (년지/일지 기준)
도화살_규칙 = {
    '인': '묘', '오': '묘', '술': '묘',  # 인오술 → 묘
    '사': '오', '유': '오', '축': '오',  # 사유축 → 오
    '신': '유', '자': '유', '진': '유',  # 신자진 → 유
    '해': '자', '묘': '자', '미': '자',  # 해묘미 → 자
}

# 역마살 (년지/일지 기준)
역마살_규칙 = {
    '인': '신', '오': '신', '술': '신',  # 인오술 → 신
    '사': '해', '유': '해', '축': '해',  # 사유축 → 해
    '신': '인', '자': '인', '진': '인',  # 신자진 → 인
    '해': '사', '묘': '사', '미': '사',  # 해묘미 → 사
}

# 화개살 (년지/일지 기준)
화개살_규칙 = {
    '인': '술', '오': '술', '술': '술',  # 인오술 → 술
    '사': '축', '유': '축', '축': '축',  # 사유축 → 축
    '신': '진', '자': '진', '진': '진',  # 신자진 → 진
    '해': '미', '묘': '미', '미': '미',  # 해묘미 → 미
}

# 양인살 (일간 기준) - 양간만 해당
양인살_규칙 = {
    '갑': '묘', '병': '오', '무': '오', '경': '유', '임': '자',
}

# 천을귀인 (일간 기준)
천을귀인_규칙 = {
    '갑': ['축', '미'], '무': ['축', '미'],
    '을': ['자', '신'], '기': ['자', '신'],
    '병': ['해', '유'], '정': ['해', '유'],
    '경': ['축', '미'], '신': ['인', '오'],
    '임': ['묘', '사'], '계': ['묘', '사'],
}

# 천덕귀인 (월지 기준)
천덕귀인_규칙 = {
    '인': '정', '묘': '신', '진': '임', '사': '신',
    '오': '갑', '미': '계', '신': '임', '유': '병',
    '술': '을', '해': '갑', '자': '계', '축': '경',
}

# 월덕귀인 (월지 기준)
월덕귀인_규칙 = {
    '인': '병', '오': '병', '술': '병',  # 인오술 → 병
    '사': '신', '유': '신', '축': '신',  # 사유축 → 신
    '신': '임', '자': '임', '진': '임',  # 신자진 → 임
    '해': '갑', '묘': '갑', '미': '갑',  # 해묘미 → 갑
}

# 문창귀인 (일간 기준)
문창귀인_규칙 = {
    '갑': '사', '을': '오', '병': '신', '정': '유',
    '무': '신', '기': '유', '경': '해', '신': '자',
    '임': '인', '계': '묘',
}

# 태극귀인 (일간 기준)
태극귀인_규칙 = {
    '갑': ['자', '오'], '기': ['자', '오'],
    '을': ['축', '미'], '경': ['축', '미'],
    '병': ['인', '신'], '신': ['인', '신'],
    '정': ['묘', '유'], '임': ['묘', '유'],
    '무': ['진', '술'], '계': ['진', '술'],
}

# 천의성 (일간 기준)
천의성_규칙 = {
    '갑': '축', '을': '자', '병': '해', '정': '술',
    '무': '유', '기': '신', '경': '미', '신': '오',
    '임': '사', '계': '진',
}

# 현침살 (일지 기준으로 천간/지지에서 찾음)
현침살_천간 = ['신', '임']  # 신금, 임수
현침살_지지 = ['유', '해']  # 유금, 해수

# 귀문관살 (일간 기준)
귀문관살_규칙 = {
    '갑': '미', '을': '오', '병': '사', '정': '진',
    '무': '사', '기': '진', '경': '묘', '신': '인',
    '임': '축', '계': '자',
}

# 백호살 (년지 기준)
백호살_규칙 = {
    '자': '오', '축': '미', '인': '신', '묘': '유',
    '진': '술', '사': '해', '오': '자', '미': '축',
    '신': '인', '유': '묘', '술': '진', '해': '사',
}

# 겁살 (년지/일지 기준)
겁살_규칙 = {
    '인': '사', '오': '사', '술': '사',  # 인오술 → 사
    '사': '인', '유': '인', '축': '인',  # 사유축 → 인
    '신': '해', '자': '해', '진': '해',  # 신자진 → 해
    '해': '신', '묘': '신', '미': '신',  # 해묘미 → 신
}

# 망신살 (년지/일지 기준)
망신살_규칙 = {
    '인': '신', '오': '자', '술': '진',
    '사': '해', '유': '묘', '축': '미',
    '신': '인', '자': '오', '진': '술',
    '해': '사', '묘': '유', '미': '축',
}

# 공망 (일주 기준) - 갑자순~계유순
공망_규칙 = {
    # 갑자순 (갑자~계유) → 술해 공망
    '갑자': ['술', '해'], '을축': ['술', '해'], '병인': ['술', '해'], 
    '정묘': ['술', '해'], '무진': ['술', '해'], '기사': ['술', '해'],
    '경오': ['술', '해'], '신미': ['술', '해'], '임신': ['술', '해'], '계유': ['술', '해'],
    # 갑술순 (갑술~계미) → 신유 공망
    '갑술': ['신', '유'], '을해': ['신', '유'], '병자': ['신', '유'],
    '정축': ['신', '유'], '무인': ['신', '유'], '기묘': ['신', '유'],
    '경진': ['신', '유'], '신사': ['신', '유'], '임오': ['신', '유'], '계미': ['신', '유'],
    # 갑신순 (갑신~계사) → 오미 공망
    '갑신': ['오', '미'], '을유': ['오', '미'], '병술': ['오', '미'],
    '정해': ['오', '미'], '무자': ['오', '미'], '기축': ['오', '미'],
    '경인': ['오', '미'], '신묘': ['오', '미'], '임진': ['오', '미'], '계사': ['오', '미'],
    # 갑오순 (갑오~계묘) → 진사 공망
    '갑오': ['진', '사'], '을미': ['진', '사'], '병신': ['진', '사'],
    '정유': ['진', '사'], '무술': ['진', '사'], '기해': ['진', '사'],
    '경자': ['진', '사'], '신축': ['진', '사'], '임인': ['진', '사'], '계묘': ['진', '사'],
    # 갑진순 (갑진~계축) → 인묘 공망
    '갑진': ['인', '묘'], '을사': ['인', '묘'], '병오': ['인', '묘'],
    '정미': ['인', '묘'], '무신': ['인', '묘'], '기유': ['인', '묘'],
    '경술': ['인', '묘'], '신해': ['인', '묘'], '임자': ['인', '묘'], '계축': ['인', '묘'],
    # 갑인순 (갑인~계해) → 자축 공망
    '갑인': ['자', '축'], '을묘': ['자', '축'], '병진': ['자', '축'],
    '정사': ['자', '축'], '무오': ['자', '축'], '기미': ['자', '축'],
    '경신': ['자', '축'], '신유': ['자', '축'], '임술': ['자', '축'], '계해': ['자', '축'],
}

# 홍염살 (일간 기준)
홍염살_규칙 = {
    '갑': '오', '을': '신', '병': '인', '정': '미',
    '무': '진', '기': '진', '경': '술', '신': '유',
    '임': '자', '계': '신',
}

# 과숙살 (고란살) - 일지 기준
과숙살_일지 = ['인', '진', '사', '미', '술', '해']  # 양남/음녀
고란살_일지 = ['자', '축', '묘', '오', '신', '유']  # 음남/양녀

# 고신살 (년지 기준)
고신살_규칙 = {
    '자': '인', '축': '인', '인': '사', '묘': '사',
    '진': '사', '사': '신', '오': '신', '미': '신',
    '신': '해', '유': '해', '술': '해', '해': '인',
}

# 과강살 (일주 특정 조합)
과강살_일주 = ['무진', '무술', '경진', '경술', '임진', '임술']

# 장성살 (년지 기준)
장성살_규칙 = {
    '인': '사', '오': '사', '술': '사',
    '사': '신', '유': '신', '축': '신',
    '신': '해', '자': '해', '진': '해',
    '해': '인', '묘': '인', '미': '인',
}

# 반안살 (년지 기준)
반안살_규칙 = {
    '인': '술', '오': '인', '술': '오',
    '사': '축', '유': '사', '축': '유',
    '신': '진', '자': '신', '진': '자',
    '해': '미', '묘': '해', '미': '묘',
}


def calc_신살(사주_data, gender='남'):
    """
    신살 계산
    사주_data: calc_사주() 결과
    gender: '남' 또는 '여'
    
    Returns: {
        '천간신살': {'년': [...], '월': [...], '일': [...], '시': [...]},
        '지지신살': {'년': [...], '월': [...], '일': [...], '시': [...]},
        '길신': [...],
        '흉신': [...],
        '특수신살': [...],
    }
    """
    
    일간 = 사주_data['일주'][0]
    일지 = 사주_data['일주'][1]
    년지 = 사주_data['년주'][1]
    월지 = 사주_data['월주'][1]
    시지 = 사주_data['시주'][1]
    
    년간 = 사주_data['년주'][0]
    월간 = 사주_data['월주'][0]
    시간 = 사주_data['시주'][0]
    
    일주 = 일간 + 일지
    
    # 결과 초기화
    천간신살 = {'년': [], '월': [], '일': [], '시': []}
    지지신살 = {'년': [], '월': [], '일': [], '시': []}
    길신 = []
    흉신 = []
    특수신살 = []
    
    지지들 = {'년': 년지, '월': 월지, '일': 일지, '시': 시지}
    천간들 = {'년': 년간, '월': 월간, '일': 일간, '시': 시간}
    
    # ========== 도화살 (년지, 일지 기준) ==========
    for 기준 in [년지, 일지]:
        if 기준 in 도화살_규칙:
            도화_지지 = 도화살_규칙[기준]
            for col, 지지 in 지지들.items():
                if 지지 == 도화_지지 and '도화살' not in 지지신살[col]:
                    지지신살[col].append('도화살')
                    if ('도화살', col) not in [(x[0], x[1]) for x in 흉신]:
                        흉신.append(('도화살', col))
    
    # ========== 역마살 (년지, 일지 기준) ==========
    for 기준 in [년지, 일지]:
        if 기준 in 역마살_규칙:
            역마_지지 = 역마살_규칙[기준]
            for col, 지지 in 지지들.items():
                if 지지 == 역마_지지 and '역마살' not in 지지신살[col]:
                    지지신살[col].append('역마살')
                    if ('역마살', col) not in [(x[0], x[1]) for x in 흉신]:
                        흉신.append(('역마살', col))
    
    # ========== 화개살 (년지, 일지 기준) ==========
    for 기준 in [년지, 일지]:
        if 기준 in 화개살_규칙:
            화개_지지 = 화개살_규칙[기준]
            for col, 지지 in 지지들.items():
                if 지지 == 화개_지지 and '화개살' not in 지지신살[col]:
                    지지신살[col].append('화개살')
                    if ('화개살', col) not in [(x[0], x[1]) for x in 특수신살]:
                        특수신살.append(('화개살', col))
    
    # ========== 양인살 (일간 기준) ==========
    if 일간 in 양인살_규칙:
        양인_지지 = 양인살_규칙[일간]
        for col, 지지 in 지지들.items():
            if 지지 == 양인_지지 and '양인살' not in 지지신살[col]:
                지지신살[col].append('양인살')
                if ('양인살', col) not in [(x[0], x[1]) for x in 흉신]:
                    흉신.append(('양인살', col))
    
    # ========== 천을귀인 (일간 기준) ==========
    if 일간 in 천을귀인_규칙:
        귀인_지지들 = 천을귀인_규칙[일간]
        for col, 지지 in 지지들.items():
            if 지지 in 귀인_지지들 and '천을귀인' not in 지지신살[col]:
                지지신살[col].append('천을귀인')
                if ('천을귀인', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('천을귀인', col))
    
    # ========== 천덕귀인 (월지 기준) ==========
    if 월지 in 천덕귀인_규칙:
        천덕_천간 = 천덕귀인_규칙[월지]
        for col, 천간 in 천간들.items():
            if 천간 == 천덕_천간 and '천덕귀인' not in 천간신살[col]:
                천간신살[col].append('천덕귀인')
                if ('천덕귀인', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('천덕귀인', col))
    
    # ========== 월덕귀인 (월지 기준) ==========
    if 월지 in 월덕귀인_규칙:
        월덕_천간 = 월덕귀인_규칙[월지]
        for col, 천간 in 천간들.items():
            if 천간 == 월덕_천간 and '월덕귀인' not in 천간신살[col]:
                천간신살[col].append('월덕귀인')
                if ('월덕귀인', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('월덕귀인', col))
    
    # ========== 문창귀인 (일간 기준) ==========
    if 일간 in 문창귀인_규칙:
        문창_지지 = 문창귀인_규칙[일간]
        for col, 지지 in 지지들.items():
            if 지지 == 문창_지지 and '문창귀인' not in 지지신살[col]:
                지지신살[col].append('문창귀인')
                if ('문창귀인', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('문창귀인', col))
    
    # ========== 태극귀인 (일간 기준) ==========
    if 일간 in 태극귀인_규칙:
        태극_지지들 = 태극귀인_규칙[일간]
        for col, 지지 in 지지들.items():
            if 지지 in 태극_지지들 and '태극귀인' not in 지지신살[col]:
                지지신살[col].append('태극귀인')
                if ('태극귀인', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('태극귀인', col))
    
    # ========== 천의성 (일간 기준) ==========
    if 일간 in 천의성_규칙:
        천의_지지 = 천의성_규칙[일간]
        for col, 지지 in 지지들.items():
            if 지지 == 천의_지지 and '천의성' not in 지지신살[col]:
                지지신살[col].append('천의성')
                if ('천의성', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('천의성', col))
    
    # ========== 현침살 (특정 천간/지지) ==========
    for col, 천간 in 천간들.items():
        if 천간 in 현침살_천간 and '현침살' not in 천간신살[col]:
            천간신살[col].append('현침살')
            if ('현침살', col + '간') not in [(x[0], x[1]) for x in 특수신살]:
                특수신살.append(('현침살', col + '간'))
    
    for col, 지지 in 지지들.items():
        if 지지 in 현침살_지지 and '현침살' not in 지지신살[col]:
            지지신살[col].append('현침살')
            if ('현침살', col + '지') not in [(x[0], x[1]) for x in 특수신살]:
                특수신살.append(('현침살', col + '지'))
    
    # ========== 귀문관살 (일간 기준) ==========
    if 일간 in 귀문관살_규칙:
        귀문_지지 = 귀문관살_규칙[일간]
        for col, 지지 in 지지들.items():
            if 지지 == 귀문_지지 and '귀문관살' not in 지지신살[col]:
                지지신살[col].append('귀문관살')
                if ('귀문관살', col) not in [(x[0], x[1]) for x in 흉신]:
                    흉신.append(('귀문관살', col))
    
    # ========== 백호살 (년지 기준) ==========
    if 년지 in 백호살_규칙:
        백호_지지 = 백호살_규칙[년지]
        for col, 지지 in 지지들.items():
            if 지지 == 백호_지지 and '백호살' not in 지지신살[col]:
                지지신살[col].append('백호살')
                if ('백호살', col) not in [(x[0], x[1]) for x in 흉신]:
                    흉신.append(('백호살', col))
    
    # ========== 겁살 (년지, 일지 기준) ==========
    for 기준 in [년지, 일지]:
        if 기준 in 겁살_규칙:
            겁살_지지 = 겁살_규칙[기준]
            for col, 지지 in 지지들.items():
                if 지지 == 겁살_지지 and '겁살' not in 지지신살[col]:
                    지지신살[col].append('겁살')
                    if ('겁살', col) not in [(x[0], x[1]) for x in 흉신]:
                        흉신.append(('겁살', col))
    
    # ========== 망신살 (년지 기준) ==========
    if 년지 in 망신살_규칙:
        망신_지지 = 망신살_규칙[년지]
        for col, 지지 in 지지들.items():
            if 지지 == 망신_지지 and '망신살' not in 지지신살[col]:
                지지신살[col].append('망신살')
                if ('망신살', col) not in [(x[0], x[1]) for x in 흉신]:
                    흉신.append(('망신살', col))
    
    # ========== 공망 (일주 기준) ==========
    if 일주 in 공망_규칙:
        공망_지지들 = 공망_규칙[일주]
        for col, 지지 in 지지들.items():
            if 지지 in 공망_지지들 and '공망' not in 지지신살[col]:
                지지신살[col].append('공망')
                if ('공망', col) not in [(x[0], x[1]) for x in 특수신살]:
                    특수신살.append(('공망', col))
    
    # ========== 홍염살 (일간 기준) ==========
    if 일간 in 홍염살_규칙:
        홍염_지지 = 홍염살_규칙[일간]
        for col, 지지 in 지지들.items():
            if 지지 == 홍염_지지 and '홍염살' not in 지지신살[col]:
                지지신살[col].append('홍염살')
                if ('홍염살', col) not in [(x[0], x[1]) for x in 특수신살]:
                    특수신살.append(('홍염살', col))
    
    # ========== 과강살 (일주 특정 조합) ==========
    if 일주 in 과강살_일주:
        if '과강살' not in 지지신살['일']:
            지지신살['일'].append('과강살')
            특수신살.append(('과강살', '일'))
    
    # ========== 장성살 (년지 기준) ==========
    if 년지 in 장성살_규칙:
        장성_지지 = 장성살_규칙[년지]
        for col, 지지 in 지지들.items():
            if 지지 == 장성_지지 and '장성살' not in 지지신살[col]:
                지지신살[col].append('장성살')
                if ('장성살', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('장성살', col))
    
    # ========== 반안살 (년지 기준) ==========
    if 년지 in 반안살_규칙:
        반안_지지 = 반안살_규칙[년지]
        for col, 지지 in 지지들.items():
            if 지지 == 반안_지지 and '반안살' not in 지지신살[col]:
                지지신살[col].append('반안살')
                if ('반안살', col) not in [(x[0], x[1]) for x in 길신]:
                    길신.append(('반안살', col))
    
    return {
        '천간신살': 천간신살,
        '지지신살': 지지신살,
        '길신': 길신,
        '흉신': 흉신,
        '특수신살': 특수신살,
    }

# ============================================
# 12운성표 데이터 (전체 테이블)
# ============================================
운성_순서 = ['장생', '목욕', '관대', '건록', '제왕', '쇠', '병', '사', '묘', '절', '태', '양']

# 각 천간이 장생하는 지지 (양간/음간 다름)
천간_장생지 = {
    '갑': '해', '을': '오',
    '병': '인', '정': '유',
    '무': '인', '기': '유',
    '경': '사', '신': '자',
    '임': '신', '계': '묘',
}

def calc_12운성_전체(일간):
    """일간 기준 12지지별 12운성 반환"""
    장생지 = 천간_장생지[일간]
    장생_idx = 지지.index(장생지)
    
    결과 = {}
    for i, 지지명 in enumerate(지지):
        # 장생지로부터의 거리 계산
        거리 = (i - 장생_idx) % 12
        운성 = 운성_순서[거리]
        결과[지지명] = 운성
    
    return 결과


# ============================================
# 지장간 데이터 (전체 테이블)
# ============================================
지장간_테이블 = {
    '자': {'여기': None, '중기': None, '본기': '계'},
    '축': {'여기': '계', '중기': '신', '본기': '기'},
    '인': {'여기': '무', '중기': '병', '본기': '갑'},
    '묘': {'여기': None, '중기': None, '본기': '을'},
    '진': {'여기': '을', '중기': '계', '본기': '무'},
    '사': {'여기': '무', '중기': '경', '본기': '병'},
    '오': {'여기': '병', '중기': '기', '본기': '정'},
    '미': {'여기': '정', '중기': '을', '본기': '기'},
    '신': {'여기': '기', '중기': '임', '본기': '경'},
    '유': {'여기': None, '중기': None, '본기': '신'},
    '술': {'여기': '신', '중기': '정', '본기': '무'},
    '해': {'여기': '무', '중기': '갑', '본기': '임'},
}

def calc_지장간_전체():
    """전체 지장간 테이블 반환"""
    return 지장간_테이블


# ============================================
# 합충형파해 분석
# ============================================

# 육합 (지지 두 개가 합하여 새 오행 생성)
육합 = {
    ('자', '축'): '토', ('축', '자'): '토',
    ('인', '해'): '목', ('해', '인'): '목',
    ('묘', '술'): '화', ('술', '묘'): '화',
    ('진', '유'): '금', ('유', '진'): '금',
    ('사', '신'): '수', ('신', '사'): '수',
    ('오', '미'): '화', ('미', '오'): '화',
}

# 삼합 (세 지지가 합하여 오행 생성)
삼합 = {
    '목': ['해', '묘', '미'],
    '화': ['인', '오', '술'],
    '금': ['사', '유', '축'],
    '수': ['신', '자', '진'],
}

# 방합 (같은 계절 지지)
방합 = {
    '목': ['인', '묘', '진'],  # 봄
    '화': ['사', '오', '미'],  # 여름
    '금': ['신', '유', '술'],  # 가을
    '수': ['해', '자', '축'],  # 겨울
}

# 충 (대각선 반대)
충 = [
    ('자', '오'), ('축', '미'), ('인', '신'),
    ('묘', '유'), ('진', '술'), ('사', '해'),
]

# 형
삼형 = {
    '무은지형': ['인', '사', '신'],  # 은혜를 모르는 형
    '무례지형': ['축', '술', '미'],  # 예의 없는 형
    '자형': [('진', '진'), ('오', '오'), ('유', '유'), ('해', '해')],  # 스스로 형
}
형 = [
    ('인', '사'), ('사', '신'), ('신', '인'),  # 무은지형
    ('축', '술'), ('술', '미'), ('미', '축'),  # 무례지형
    ('자', '묘'),  # 무례지형
]

# 파
파 = [
    ('자', '유'), ('유', '자'),
    ('축', '진'), ('진', '축'),
    ('인', '해'), ('해', '인'),
    ('묘', '오'), ('오', '묘'),
    ('사', '신'), ('신', '사'),
    ('미', '술'), ('술', '미'),
]

# 해
해 = [
    ('자', '미'), ('미', '자'),
    ('축', '오'), ('오', '축'),
    ('인', '사'), ('사', '인'),
    ('묘', '진'), ('진', '묘'),
    ('신', '해'), ('해', '신'),
    ('유', '술'), ('술', '유'),
]

def calc_합충형파해(사주_data):
    """원국 내 합충형파해 관계 분석"""
    
    지지들 = {
        '년': 사주_data['년주'][1],
        '월': 사주_data['월주'][1],
        '일': 사주_data['일주'][1],
        '시': 사주_data['시주'][1],
    }
    
    결과 = {
        '육합': [],
        '삼합': [],
        '방합': [],
        '충': [],
        '형': [],
        '파': [],
        '해': [],
    }
    
    위치_목록 = ['년', '월', '일', '시']
    
    # 모든 쌍 검사
    for i in range(len(위치_목록)):
        for j in range(i + 1, len(위치_목록)):
            위치1, 위치2 = 위치_목록[i], 위치_목록[j]
            지지1, 지지2 = 지지들[위치1], 지지들[위치2]
            
            # 육합 검사
            if (지지1, 지지2) in 육합:
                결과['육합'].append({
                    '위치': f"{위치1}-{위치2}",
                    '지지': f"{지지1}-{지지2}",
                    '합화': 육합[(지지1, 지지2)]
                })
            
            # 충 검사
            if (지지1, 지지2) in 충 or (지지2, 지지1) in 충:
                결과['충'].append({
                    '위치': f"{위치1}-{위치2}",
                    '지지': f"{지지1}-{지지2}",
                })
            
            # 형 검사
            if (지지1, 지지2) in 형 or (지지2, 지지1) in 형:
                결과['형'].append({
                    '위치': f"{위치1}-{위치2}",
                    '지지': f"{지지1}-{지지2}",
                })
            
            # 파 검사
            if (지지1, 지지2) in 파:
                결과['파'].append({
                    '위치': f"{위치1}-{위치2}",
                    '지지': f"{지지1}-{지지2}",
                })
            
            # 해 검사
            if (지지1, 지지2) in 해:
                결과['해'].append({
                    '위치': f"{위치1}-{위치2}",
                    '지지': f"{지지1}-{지지2}",
                })
    
    # 삼합 검사 (세 지지 중 두 개 이상 있는지)
    지지_set = set(지지들.values())
    for 오행, 지지_리스트 in 삼합.items():
        matches = [z for z in 지지_리스트 if z in 지지_set]
        if len(matches) >= 2:
            결과['삼합'].append({
                '오행': 오행,
                '지지': matches,
                '완성': len(matches) == 3
            })
    
    # 방합 검사
    for 오행, 지지_리스트 in 방합.items():
        matches = [z for z in 지지_리스트 if z in 지지_set]
        if len(matches) >= 2:
            결과['방합'].append({
                '오행': 오행,
                '지지': matches,
                '완성': len(matches) == 3
            })
    
    return 결과


# ============================================
# 천간합 분석
# ============================================
천간합 = {
    ('갑', '기'): '토', ('기', '갑'): '토',
    ('을', '경'): '금', ('경', '을'): '금',
    ('병', '신'): '수', ('신', '병'): '수',
    ('정', '임'): '목', ('임', '정'): '목',
    ('무', '계'): '화', ('계', '무'): '화',
}

def calc_천간합(사주_data):
    """원국 내 천간합 분석"""
    
    천간들 = {
        '년': 사주_data['년주'][0],
        '월': 사주_data['월주'][0],
        '일': 사주_data['일주'][0],
        '시': 사주_data['시주'][0],
    }
    
    결과 = []
    위치_목록 = ['년', '월', '일', '시']
    
    for i in range(len(위치_목록)):
        for j in range(i + 1, len(위치_목록)):
            위치1, 위치2 = 위치_목록[i], 위치_목록[j]
            천간1, 천간2 = 천간들[위치1], 천간들[위치2]
            
            if (천간1, 천간2) in 천간합:
                결과.append({
                    '위치': f"{위치1}-{위치2}",
                    '천간': f"{천간1}-{천간2}",
                    '합화': 천간합[(천간1, 천간2)]
                })
    
    return 결과


# ============================================
# 공망 분석
# ============================================
def calc_공망_전체(사주_data):
    """각 주별 공망 분석"""
    
    결과 = {}
    
    for col in ['년', '월', '일', '시']:
        천간_글자 = 사주_data[f'{col}주'][0]
        지지_글자 = 사주_data[f'{col}주'][1]
        
        천간_idx = 천간.index(천간_글자)
        지지_idx = 지지.index(지지_글자)
        
        # 갑자순 시작점 찾기 (천간이 갑이 되는 지점)
        순_시작_지지_idx = (지지_idx - 천간_idx) % 12
        
        # 공망 = 순에서 10, 11번째 지지 (술, 해 / 신, 유 등)
        공망1_idx = (순_시작_지지_idx + 10) % 12
        공망2_idx = (순_시작_지지_idx + 11) % 12
        
        결과[col] = {
            '공망': [지지[공망1_idx], 지지[공망2_idx]],
            '순': f"갑{지지[순_시작_지지_idx]}순"
        }
    
    # 원국 내 공망 해당 여부 확인
    일주_공망 = 결과['일']['공망']
    지지들 = [사주_data['년주'][1], 사주_data['월주'][1], 
              사주_data['일주'][1], 사주_data['시주'][1]]
    
    공망_해당 = []
    for i, (col, 지지_글자) in enumerate(zip(['년', '월', '일', '시'], 지지들)):
        if 지지_글자 in 일주_공망:
            공망_해당.append({'위치': col, '지지': 지지_글자})
    
    결과['공망_해당'] = 공망_해당
    
    return 결과


# ============================================
# 궁성 분석
# ============================================
def calc_궁성(사주_data):
    """사주 궁성 분석"""
    
    일간 = 사주_data['일주'][0]
    
    궁성 = {
        '년주': {
            '궁': '조상궁/사회궁',
            '의미': '조상, 윗사람, 사회적 위치, 초년운 (1~15세)',
            '천간': 사주_data['년주'][0],
            '지지': 사주_data['년주'][1],
        },
        '월주': {
            '궁': '부모궁/사업궁',
            '의미': '부모, 형제, 직장, 사업, 청년운 (15~30세)',
            '천간': 사주_data['월주'][0],
            '지지': 사주_data['월주'][1],
        },
        '일주': {
            '궁': '본인궁/배우자궁',
            '의미': '본인, 배우자, 가정, 중년운 (30~45세)',
            '천간': 사주_data['일주'][0],
            '지지': 사주_data['일주'][1],
        },
        '시주': {
            '궁': '자녀궁/노년궁',
            '의미': '자녀, 후배, 말년, 결과, 노년운 (45세 이후)',
            '천간': 사주_data['시주'][0],
            '지지': 사주_data['시주'][1],
        },
    }
    
    return 궁성


# ============================================
# 육친 분석
# ============================================
def calc_육친(사주_data, gender='남'):
    """십성을 육친(가족관계)으로 변환"""
    
    # 남자 육친
    육친_남 = {
        '비견': '형제/친구',
        '겁재': '형제/경쟁자',
        '식신': '장남/장손',
        '상관': '자녀/손자',
        '편재': '아버지/애인',
        '정재': '아내/재물',
        '편관': '자녀(아들)',
        '정관': '자녀(딸)/직장',
        '편인': '편모/계모',
        '정인': '어머니/학문',
    }
    
    # 여자 육친
    육친_여 = {
        '비견': '자매/친구',
        '겁재': '자매/경쟁자',
        '식신': '자녀(딸)',
        '상관': '자녀(아들)',
        '편재': '아버지/시아버지',
        '정재': '재물/시어머니',
        '편관': '애인/남자',
        '정관': '남편/직장',
        '편인': '편모/계모',
        '정인': '어머니/학문',
    }
    
    육친_표 = 육친_남 if gender == '남' else 육친_여
    
    결과 = {}
    
    for col in ['년', '월', '일', '시']:
        천간_십성 = 사주_data['천간십성'][col]
        지지_십성 = 사주_data['지지십성'][col]
        
        결과[col] = {
            '천간': {
                '십성': 천간_십성,
                '육친': 육친_표.get(천간_십성, '-') if 천간_십성 != '일간(나)' else '본인'
            },
            '지지': {
                '십성': 지지_십성,
                '육친': 육친_표.get(지지_십성, '-')
            }
        }
    
    return 결과


# ============================================
# 납음오행
# ============================================
납음_60갑자 = {
    '갑자': '해중금', '을축': '해중금',
    '병인': '노중화', '정묘': '노중화',
    '무진': '대림목', '기사': '대림목',
    '경오': '노방토', '신미': '노방토',
    '임신': '검봉금', '계유': '검봉금',
    '갑술': '산두화', '을해': '산두화',
    '병자': '간하수', '정축': '간하수',
    '무인': '성두토', '기묘': '성두토',
    '경진': '백랍금', '신사': '백랍금',
    '임오': '양류목', '계미': '양류목',
    '갑신': '천천수', '을유': '천천수',
    '병술': '옥상토', '정해': '옥상토',
    '무자': '벽력화', '기축': '벽력화',
    '경인': '송백목', '신묘': '송백목',
    '임진': '장류수', '계사': '장류수',
    '갑오': '사중금', '을미': '사중금',
    '병신': '산하화', '정유': '산하화',
    '무술': '평지목', '기해': '평지목',
    '경자': '벽상토', '신축': '벽상토',
    '임인': '금박금', '계묘': '금박금',
    '갑진': '복등화', '을사': '복등화',
    '병오': '천하수', '정미': '천하수',
    '무신': '대역토', '기유': '대역토',
    '경술': '차천금', '신해': '차천금',
    '임자': '상자목', '계축': '상자목',
    '갑인': '대계수', '을묘': '대계수',
    '병진': '사중토', '정사': '사중토',
    '무오': '천상화', '기미': '천상화',
    '경신': '석류목', '신유': '석류목',
    '임술': '대해수', '계해': '대해수',
}

납음_설명 = {
    '해중금': ('금', '바다 속 금, 숨겨진 보물'),
    '노중화': ('화', '화로 속 불, 실용적 열정'),
    '대림목': ('목', '큰 숲의 나무, 성장과 발전'),
    '노방토': ('토', '길가의 흙, 안정과 포용'),
    '검봉금': ('금', '칼날의 금, 예리함과 결단'),
    '산두화': ('화', '산꼭대기 불, 높은 이상'),
    '간하수': ('수', '시냇물, 유연함과 적응'),
    '성두토': ('토', '성벽의 흙, 방어와 보호'),
    '백랍금': ('금', '백랍(밀납)처럼 유연한 금'),
    '양류목': ('목', '버드나무, 유연함과 인내'),
    '천천수': ('수', '샘물, 순수함과 시작'),
    '옥상토': ('토', '지붕 위 흙, 높은 위치'),
    '벽력화': ('화', '번개불, 강렬함과 순간'),
    '송백목': ('목', '소나무/잣나무, 절개와 지조'),
    '장류수': ('수', '긴 흐르는 물, 지속성'),
    '사중금': ('금', '모래 속 금, 숨겨진 가치'),
    '산하화': ('화', '산 아래 불, 따뜻함'),
    '평지목': ('목', '평지의 나무, 평범한 성장'),
    '벽상토': ('토', '벽의 흙, 견고함'),
    '금박금': ('금', '금박, 화려함과 외면'),
    '복등화': ('화', '등불, 밝음과 인도'),
    '천하수': ('수', '하늘 아래 물, 비/은혜'),
    '대역토': ('토', '큰 들판 흙, 광대함'),
    '차천금': ('금', '수레의 금, 이동과 교류'),
    '상자목': ('목', '뽕나무, 실용성'),
    '대계수': ('수', '큰 시냇물, 풍요'),
    '사중토': ('토', '모래 속 흙, 혼합'),
    '천상화': ('화', '하늘 위 불, 태양/최고'),
    '석류목': ('목', '석류나무, 결실과 풍요'),
    '대해수': ('수', '큰 바다, 포용과 깊이'),
}

def calc_납음오행(사주_data):
    """각 주의 납음오행 계산"""
    
    결과 = {}
    
    for col in ['년', '월', '일', '시']:
        천간 = 사주_data[f'{col}주'][0]
        지지 = 사주_data[f'{col}주'][1]
        간지 = 천간 + 지지
        
        납음 = 납음_60갑자.get(간지, '?')
        오행, 설명 = 납음_설명.get(납음, ('?', ''))
        
        결과[col] = {
            '간지': 간지,
            '납음': 납음,
            '오행': 오행,
            '설명': 설명,
        }
    
    return 결과


# ============================================
# 격국 분석 (간단 버전)
# ============================================
def calc_격국(사주_data):
    """격국 분석 (월지 기준 기본 격국)"""
    
    일간 = 사주_data['일주'][0]
    월지 = 사주_data['월주'][1]
    월지_지장간 = 지장간_테이블[월지]['본기']
    
    일간_idx = 천간.index(일간)
    일간_오행 = 천간_오행[일간_idx]
    
    # 월지 본기의 십성 계산
    if 월지_지장간:
        지장간_idx = 천간.index(월지_지장간)
        지장간_오행 = 천간_오행[지장간_idx]
        
        # 십성 계산
        십성 = calc_십성_single(일간, 월지_지장간)
    else:
        십성 = '?'
    
    # 격국 이름
    격국_이름 = {
        '비견': '비견격',
        '겁재': '겁재격',
        '식신': '식신격',
        '상관': '상관격',
        '편재': '편재격',
        '정재': '정재격',
        '편관': '편관격 (칠살격)',
        '정관': '정관격',
        '편인': '편인격 (효신격)',
        '정인': '정인격',
    }
    
    격국 = 격국_이름.get(십성, '특수격')
    
    # 특수격 체크
    특수격 = []
    
    # 종격 체크 (간단 버전 - 일간이 매우 약할 때)
    일간_count = 0
    for col in ['년', '월', '일', '시']:
        천간_글자 = 사주_data[f'{col}주'][0]
        if 천간_오행[천간.index(천간_글자)] == 일간_오행:
            일간_count += 1
    
    if 일간_count <= 1:
        특수격.append('종격 가능성')
    
    # 건록격/양인격 체크
    일간_건록지 = {
        '갑': '인', '을': '묘', '병': '사', '정': '오', '무': '사',
        '기': '오', '경': '신', '신': '유', '임': '해', '계': '자'
    }
    
    if 월지 == 일간_건록지.get(일간):
        특수격.append('건록격')
    
    return {
        '정격': 격국,
        '월지': 월지,
        '월지_본기': 월지_지장간,
        '십성': 십성,
        '특수격': 특수격,
    }

def calc_십성_single(일간, 타천간):
    """단일 천간 간 십성 계산"""
    일간_idx = 천간.index(일간)
    타_idx = 천간.index(타천간)
    
    일간_오행 = 천간_오행[일간_idx]
    타_오행 = 천간_오행[타_idx]
    
    일간_음양 = 천간_음양[일간_idx]
    타_음양 = 천간_음양[타_idx]
    
    오행_순서 = ['목', '화', '토', '금', '수']
    일간_오행_idx = 오행_순서.index(일간_오행)
    타_오행_idx = 오행_순서.index(타_오행)
    
    # 관계 계산
    차이 = (타_오행_idx - 일간_오행_idx) % 5
    
    if 차이 == 0:  # 같은 오행
        십성 = '비견' if 일간_음양 == 타_음양 else '겁재'
    elif 차이 == 1:  # 내가 생하는 것
        십성 = '식신' if 일간_음양 == 타_음양 else '상관'
    elif 차이 == 2:  # 내가 극하는 것
        십성 = '편재' if 일간_음양 == 타_음양 else '정재'
    elif 차이 == 3:  # 나를 극하는 것
        십성 = '편관' if 일간_음양 == 타_음양 else '정관'
    elif 차이 == 4:  # 나를 생하는 것
        십성 = '편인' if 일간_음양 == 타_음양 else '정인'
    
    return 십성


# ============================================
# 용신 분석 (간단 버전)
# ============================================
def calc_용신(사주_data):
    """
    용신 분석 - 조후/억부/통관 3가지 관점 종합
    """
    
    오행_count = 사주_data['오행'].copy()
    일간 = 사주_data['일주'][0]
    일간_오행 = 천간_오행[천간.index(일간)]
    월지 = 사주_data['월주'][1]
    월지_오행 = 지지_오행[지지.index(월지)]
    
    # ========================================
    # 1. 억부용신 (신강/신약 기준)
    # ========================================
    
    # 나를 돕는 오행: 비겁(같은 오행) + 인성(나를 생하는 오행)
    생_관계 = {'목': '수', '화': '목', '토': '화', '금': '토', '수': '금'}
    같은_오행_count = 오행_count[일간_오행]
    생하는_오행_count = 오행_count[생_관계[일간_오행]]
    
    신강_점수 = 같은_오행_count + 생하는_오행_count
    총_오행 = sum(오행_count.values())
    
    if 신강_점수 >= 5:
        신강약 = '신강'
        # 기본 설기 (나의 기운을 빼는 오행)
        기본_설기 = {'목': '화', '화': '토', '토': '금', '금': '수', '수': '목'}[일간_오행]
        
        # 특수 케이스: 금일간이 신강하고 목이 많으면 → 화로 조절이 더 효과적
        if 일간_오행 == '금' and 오행_count['목'] >= 2:
            억부_용신 = '화'  # 금↔목 충돌 시 화로 조절
        else:
            억부_용신 = 기본_설기
    elif 신강_점수 <= 2:
        신강약 = '신약'
        억부_용신 = 생_관계[일간_오행]  # 인성
    else:
        신강약 = '중화'
        # 가장 부족한 오행
        억부_용신 = min(오행_count.keys(), key=lambda x: 오행_count[x])
    
    # ========================================
    # 2. 조후용신 (계절/온도 기준)
    # ========================================
    
    # 월지별 계절 구분
    계절_map = {
        '인': '초봄', '묘': '봄', '진': '늦봄',
        '사': '초여름', '오': '여름', '미': '늦여름',
        '신': '초가을', '유': '가을', '술': '늦가을',
        '해': '초겨울', '자': '겨울', '축': '늦겨울'
    }
    계절 = 계절_map[월지]
    
    # 계절별 한난조습 판정
    한난 = ''
    if 월지 in ['해', '자', '축', '인', '묘']:  # 겨울~봄: 아직 차가움
        한난 = '한'
    elif 월지 in ['사', '오', '미']:  # 여름: 덥다
        한난 = '난'
    else:  # 봄, 가을: 중간
        한난 = '평'
    
    # 일간별 조후용신 테이블 (핵심)
    # 경금(庚): 원석 → 화로 제련 필요
    # 신금(辛): 보석 → 수로 씻어야 빛남
    # 갑목(甲): 대목 → 화(태양) 필요
    # 을목(乙): 화초 → 수 필요
    # 병화(丙): 태양 → 수로 조절
    # 정화(丁): 촛불 → 목(연료) 필요
    # 무토(戊): 산 → 목(초목)으로 풍요
    # 기토(己): 밭 → 수(수분) 필요
    # 임수(壬): 대해 → 토(제방)로 조절
    # 계수(癸): 빗물 → 화(따뜻함) 필요
    
    조후_테이블 = {
        # 경금: 기본적으로 화 필요 (제련), 여름엔 수도 필요
        '경': {'한': '화', '평': '화', '난': '수'},
        # 신금: 수로 씻어야 함, 겨울엔 화도 필요
        '신': {'한': '화', '평': '수', '난': '수'},
        # 갑목: 화(태양) 필요, 여름엔 수
        '갑': {'한': '화', '평': '화', '난': '수'},
        # 을목: 수 필요, 겨울엔 화
        '을': {'한': '화', '평': '수', '난': '수'},
        # 병화: 수로 조절, 겨울엔 목
        '병': {'한': '목', '평': '수', '난': '수'},
        # 정화: 목(연료) 필요
        '정': {'한': '목', '평': '목', '난': '수'},
        # 무토: 화로 따뜻하게, 여름엔 수
        '무': {'한': '화', '평': '목', '난': '수'},
        # 기토: 수 필요, 겨울엔 화
        '기': {'한': '화', '평': '수', '난': '수'},
        # 임수: 토(제방), 겨울엔 화
        '임': {'한': '화', '평': '토', '난': '금'},
        # 계수: 화 필요
        '계': {'한': '화', '평': '화', '난': '금'},
    }
    
    조후_용신 = 조후_테이블.get(일간, {}).get(한난, '화')
    
    # 조후 판정 설명
    if 한난 == '한':
        조후_설명 = f"{계절} 출생, 차가움 → 화(火)로 따뜻하게"
    elif 한난 == '난':
        조후_설명 = f"{계절} 출생, 더움 → 수(水)로 식혀줌"
    else:
        조후_설명 = f"{계절} 출생, 온화 → {일간} 특성에 맞게"
    
    # ========================================
    # 3. 통관용신 (충돌 중재)
    # ========================================
    
    # 상극 관계 확인 (금↔목, 수↔화 등)
    극_쌍 = [
        ('금', '목', '화'),  # 금↔목 충돌 → 화로 통관 (목생화, 화가 금 조절)
        ('수', '화', '목'),  # 수↔화 충돌 → 목으로 통관
        ('화', '금', '토'),  # 화↔금 충돌 → 토로 통관
        ('토', '수', '금'),  # 토↔수 충돌 → 금으로 통관
        ('목', '토', '화'),  # 목↔토 충돌 → 화로 통관
    ]
    
    통관_용신 = None
    통관_설명 = "해당 없음"
    
    for 공격, 피해, 중재 in 극_쌍:
        if 오행_count[공격] >= 2 and 오행_count[피해] >= 2:
            통관_용신 = 중재
            통관_설명 = f"{공격}↔{피해} 충돌 → {중재}로 중재"
            break
    
    # ========================================
    # 4. 종합 용신 판정
    # ========================================
    
    # 우선순위: 조후 > 통관 > 억부 (생명력 유지가 먼저)
    # 단, 3가지가 일치하면 확실한 용신
    
    용신_후보 = {}
    
    # 조후용신 가중치 (가장 중요)
    용신_후보[조후_용신] = 용신_후보.get(조후_용신, 0) + 4
    
    # 통관용신 가중치
    if 통관_용신:
        용신_후보[통관_용신] = 용신_후보.get(통관_용신, 0) + 3
    
    # 억부용신 가중치
    용신_후보[억부_용신] = 용신_후보.get(억부_용신, 0) + 2
    
    # 부족한 오행 보너스 (0개인 오행 - 흐름/기회의 통로)
    for 오행, count in 오행_count.items():
        if count == 0:
            용신_후보[오행] = 용신_후보.get(오행, 0) + 2
    
    # 최종 용신 결정 (점수 높은 순)
    sorted_용신 = sorted(용신_후보.items(), key=lambda x: x[1], reverse=True)
    
    # ========================================
    # 5. 용신/희신/한신/기신/구신 판정
    # ========================================
    
    생_관계 = {'목': '수', '화': '목', '토': '화', '금': '토', '수': '금'}  # A를 생하는 것
    극_관계 = {'목': '금', '화': '수', '토': '목', '금': '화', '수': '토'}  # A를 극하는 것
    피생_관계 = {'목': '화', '화': '토', '토': '금', '금': '수', '수': '목'}  # A가 생하는 것
    
    # 오행별 역할/키워드 테이블
    오행_특성 = {
        '목': {
            '용신_역할': '성장·창의·발전의 핵심',
            '용신_키워드': '콘텐츠·학습·창작·기획·인맥확장',
            '희신_역할': '성장·학습·창의 지원',
            '희신_키워드': '콘텐츠·교육·기획·인맥',
            '기신_역할': '갈등·충돌·에너지 소모',
            '기신_키워드': '과한 경쟁 금지, 감정조절 필수',
            '구신_역할': '기신 강화, 갈등 확대',
            '구신_키워드': '무리한 확장·과욕·충돌 주의',
            '한신_역할': '조건부 활용',
            '한신_키워드': '콘텐츠·학습·창작 (과하면 충돌)',
        },
        '화': {
            '용신_역할': '사주 구동핵심, 균형 회복',
            '용신_키워드': '정련·감정온도·결단·브랜드·리더십',
            '희신_역할': '표현력·열정·동기부여',
            '희신_키워드': '홍보·마케팅·영업·대인관계',
            '기신_역할': '과열·충동·소모 리스크',
            '기신_키워드': '급한 결정 금지, 냉정 유지 필수',
            '구신_역할': '기신 조장, 과열 위험',
            '구신_키워드': '무리한 추진·성급함·소진 주의',
            '한신_역할': '간헐적 활력 보조',
            '한신_키워드': '상황에 따라 활용',
        },
        '토': {
            '용신_역할': '안정·중재·신뢰의 중심',
            '용신_키워드': '조직·관리·부동산·중개·신뢰구축',
            '희신_역할': '안정·신뢰·중재 지원',
            '희신_키워드': '관리·조직·실무·기반구축',
            '기신_역할': '고집·정체·보수성 리스크',
            '기신_키워드': '고착 금지, 유연성 필수',
            '구신_역할': '기신 강화, 정체 심화',
            '구신_키워드': '무리한 안정추구·고집·지체 주의',
            '한신_역할': '안정 보조',
            '한신_키워드': '기반 유지에 가끔 활용',
        },
        '금': {
            '용신_역할': '결단·실행·정리의 핵심',
            '용신_키워드': '결단력·추진력·정리·법률·금융',
            '희신_역할': '결단·실행·마무리 지원',
            '희신_키워드': '실행력·정리·마감·효율',
            '기신_역할': '냉정·경직·고립 리스크',
            '기신_키워드': '과도 개발 금지, 조절 필수',
            '구신_역할': '기신 강화, 냉정 확대',
            '구신_키워드': '무리한 독단·고립·비타협 주의',
            '한신_역할': '정리·마무리 보조',
            '한신_키워드': '필요시 결단에 활용',
        },
        '수': {
            '용신_역할': '흐름·기회·지혜의 통로',
            '용신_키워드': '유통·네트워크·정보·이동·거래',
            '희신_역할': '흐름·정보·확장·유연성',
            '희신_키워드': '유통·네트워크·데이터·이동성',
            '기신_역할': '불안정·방황·산만 리스크',
            '기신_키워드': '변덕 금지, 일관성 필수',
            '구신_역할': '기신 조장, 불안정 확대',
            '구신_키워드': '무리한 변화·방황·산만 주의',
            '한신_역할': '보조적 흐름',
            '한신_키워드': '가끔 유동성 필요시 활용',
        },
    }
    
    # 🎯 용신(用神): 조후·억부·통관 종합 최고점
    용신_오행 = sorted_용신[0][0]
    용신_역할 = 오행_특성[용신_오행]['용신_역할']
    용신_키워드 = 오행_특성[용신_오행]['용신_키워드']
    
    # 💧 희신(喜神): 부족한 오행 중 흐름에 필요한 것 (금→수→목 순환)
    부족한_오행들 = [오행 for 오행, count in 오행_count.items() if count == 0 and 오행 != 용신_오행]
    if 부족한_오행들:
        희신_오행 = 부족한_오행들[0]
    elif len(sorted_용신) > 1:
        희신_오행 = sorted_용신[1][0]
    else:
        희신_오행 = None
    
    if 희신_오행:
        희신_역할 = 오행_특성[희신_오행]['희신_역할']
        희신_키워드 = 오행_특성[희신_오행]['희신_키워드']
    else:
        희신_역할 = "-"
        희신_키워드 = "-"
    
    # 🪙 기신(忌神): 과다한 오행 또는 용신을 극하는 오행
    과다_오행들 = [(오행, count) for 오행, count in 오행_count.items() if count >= 3]
    if 과다_오행들:
        기신_오행 = max(과다_오행들, key=lambda x: x[1])[0]
    else:
        기신_오행 = 극_관계[용신_오행]  # 용신을 극하는 오행
    
    기신_역할 = 오행_특성[기신_오행]['기신_역할']
    기신_키워드 = 오행_특성[기신_오행]['기신_키워드']
    
    # 🪨 구신(仇神): 기신을 생하는 오행 (기신 강화 → 용신 파괴)
    구신_오행 = 생_관계[기신_오행]  # 기신을 생하는 오행
    if 구신_오행 in [용신_오행, 희신_오행]:
        # 이미 용신/희신이면 다른 오행으로
        나머지 = [오행 for 오행 in ['목', '화', '토', '금', '수'] 
                  if 오행 not in [용신_오행, 희신_오행, 기신_오행]]
        구신_오행 = 나머지[-1] if 나머지 else None
    
    if 구신_오행:
        구신_역할 = 오행_특성[구신_오행]['구신_역할']
        구신_키워드 = 오행_특성[구신_오행]['구신_키워드']
    else:
        구신_역할 = "-"
        구신_키워드 = "-"
    
    # 🌳 한신(閑神): 나머지 (조건부 활용)
    사용된 = [용신_오행, 희신_오행, 기신_오행, 구신_오행]
    한신_후보 = [오행 for 오행 in ['목', '화', '토', '금', '수'] if 오행 not in 사용된]
    if 한신_후보:
        한신_오행 = 한신_후보[0]
        한신_역할 = 오행_특성[한신_오행]['한신_역할']
        한신_키워드 = 오행_특성[한신_오행]['한신_키워드']
    else:
        한신_오행 = None
        한신_역할 = "-"
        한신_키워드 = "-"
    
    return {
        # 기본 정보
        '일간': 일간,
        '일간_오행': 일간_오행,
        '월지': 월지,
        '계절': 계절,
        '오행_분포': 오행_count,
        
        # 신강약
        '신강약': 신강약,
        '신강점수': f"{신강_점수}/{총_오행}",
        
        # 3가지 관점별 용신
        '조후_용신': 조후_용신,
        '조후_설명': 조후_설명,
        '억부_용신': 억부_용신,
        '억부_설명': f"{신강약} → {'설기/제어' if 신강약 == '신강' else '보강' if 신강약 == '신약' else '균형'}",
        '통관_용신': 통관_용신,
        '통관_설명': 통관_설명,
        
        # 종합 판정 (용신/희신/한신/기신/구신)
        '용신': 용신_오행,
        '용신_역할': 용신_역할,
        '용신_키워드': 용신_키워드,
        '희신': 희신_오행,
        '희신_역할': 희신_역할,
        '희신_키워드': 희신_키워드,
        '한신': 한신_오행,
        '한신_역할': 한신_역할,
        '한신_키워드': 한신_키워드,
        '기신': 기신_오행,
        '기신_역할': 기신_역할,
        '기신_키워드': 기신_키워드,
        '구신': 구신_오행,
        '구신_역할': 구신_역할,
        '구신_키워드': 구신_키워드,
    }


# ============================================
# 일진 계산 (특정 날짜)
# ============================================
def calc_일진(year, month, day):
    """특정 날짜의 일진(천간지지) 계산"""
    from datetime import date
    
    # 기준일: 1900년 1월 1일 = 갑술일 (index 10)
    기준일 = date(1900, 1, 1)
    기준_index = 10  # 갑술
    
    target = date(year, month, day)
    days_diff = (target - 기준일).days
    
    일진_index = (기준_index + days_diff) % 60
    천간_idx = 일진_index % 10
    지지_idx = 일진_index % 12
    
    return {
        '천간': 천간[천간_idx],
        '지지': 지지[지지_idx],
        '간지': 천간[천간_idx] + 지지[지지_idx],
        '천간_한자': 천간_한자[천간_idx],
        '지지_한자': 지지_한자[지지_idx],
    }


# ============================================
# 월별 일진표 데이터 생성
# ============================================
def calc_일진표(year, month):
    """특정 년월의 일진표 데이터 생성"""
    import calendar
    from korean_lunar_calendar import KoreanLunarCalendar
    
    cal = calendar.Calendar()
    days = list(cal.itermonthdays(year, month))
    
    # 해당 월의 월주 계산
    # 먼저 년주를 구해서 년간 추출
    년간, 년지 = calc_년주(year, month, 15)
    월주_천간, 월주_지지 = calc_월주(년간, month, 15)  # 년간 전달
    
    일진_데이터 = []
    
    for day in days:
        if day == 0:
            일진_데이터.append(None)
            continue
        
        일진 = calc_일진(year, month, day)
        
        # 음력 변환
        try:
            lunar_cal = KoreanLunarCalendar()
            lunar_cal.setSolarDate(year, month, day)
            음력_월 = lunar_cal.lunarMonth
            음력_일 = lunar_cal.lunarDay
            윤달 = lunar_cal.isIntercalation
            음력_str = f"{음력_월}.{음력_일}" + ("(윤)" if 윤달 else "")
        except:
            음력_str = ""
        
        일진_데이터.append({
            'day': day,
            '양력': f"{year}-{month:02d}-{day:02d}",
            '음력': 음력_str,
            '일진': 일진['간지'],
            '천간': 일진['천간'],
            '지지': 일진['지지'],
            '천간_한자': 일진['천간_한자'],
            '지지_한자': 일진['지지_한자'],
        })
    
    return {
        'year': year,
        'month': month,
        '월주': f"{월주_천간}{월주_지지}",
        'days': 일진_데이터,
    }


# ============================================
# 테스트 - 샘플 검증
# ============================================
if __name__ == "__main__":
    print("=" * 70)
    print("샘플 2: 구대회 (1981-03-13 03:30)")
    print("=" * 70)
    result = calc_사주(1981, 3, 13, 3, 30)
    
    print(f"\n{'':10} {'시주':10} {'일주':10} {'월주':10} {'년주':10}")
    print("-" * 50)
    print(f"{'천간':10} {result['시주'][0]:10} {result['일주'][0]:10} {result['월주'][0]:10} {result['년주'][0]:10}")
    print(f"{'지지':10} {result['시주'][1]:10} {result['일주'][1]:10} {result['월주'][1]:10} {result['년주'][1]:10}")
    print(f"{'천간십성':10} {result['천간십성']['시']:10} {result['천간십성']['일']:10} {result['천간십성']['월']:10} {result['천간십성']['년']:10}")
    print(f"{'지지십성':10} {result['지지십성']['시']:10} {result['지지십성']['일']:10} {result['지지십성']['월']:10} {result['지지십성']['년']:10}")
    print(f"{'지장간':10} {result['지장간']['시']:10} {result['지장간']['일']:10} {result['지장간']['월']:10} {result['지장간']['년']:10}")
    print(f"{'12운성':10} {result['12운성']['시']:10} {result['12운성']['일']:10} {result['12운성']['월']:10} {result['12운성']['년']:10}")
    print(f"{'12신살':10} {result['12신살']['시']:10} {result['12신살']['일']:10} {result['12신살']['월']:10} {result['12신살']['년']:10}")
    
    print(f"\n오행 분포: {result['오행']}")
    
    print("\n" + "=" * 70)
    print("정답 비교 (이미지 기준)")
    print("=" * 70)
    print("천간: 무(戊) 경(庚) 신(辛) 신(辛)")
    print("지지: 인(寅) 인(寅) 묘(卯) 유(酉)")
    print("천간십성: 편인 일간(나) 겁재 겁재")
    print("지지십성: 편재 편재 정재 겁재")
    print("지장간: 무병갑 무병갑 갑을 경신")
    print("12운성: 절 절 태 제왕")
    print("12신살: 겁살 겁살 재살 장성살")
